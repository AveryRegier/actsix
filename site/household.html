<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Household Details - Deacon Care System</title>
    <link rel="stylesheet" href="site.css">
</head>
<body>
    <div class="container">
        <!-- Reusable navigation bar -->
        <div id="site-nav-container"></div>
        <script type="module">
            // Load reusable navigation bar
            document.addEventListener('DOMContentLoaded', async () => {
                const navContainer = document.getElementById('site-nav-container');
                if (navContainer) {
                    const navResp = await fetch('site-nav.html');
                    if (navResp.ok) {
                        navContainer.innerHTML = await navResp.text();
                        const script = document.createElement('script');
                        script.src = 'site-nav.js';
                        document.body.appendChild(script);
                    }
                }
            });
        </script>
        <div class="header">
            <h1 id="householdTitle">Household Details</h1>
            <p>Manage household members and information</p>
        </div>
        
        <div class="content">
            <div class="loading" id="loadingState">
                <h3>Loading household information...</h3>
                <p>Please wait while we fetch the data.</p>
            </div>
            
            <div id="householdContent" style="display: none;">
                <!-- Household Information Section -->
                <div class="section">
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <h2 style="margin-bottom:0;">Household Information</h2>
                        <a href="edit-household.html?householdId=" id="editHouseholdBtn" class="icon-btn" title="Edit Household" style="margin-left:10px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
                        </a>
                    </div>
                    <div class="household-info" id="householdInfo">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Members List Section -->
                <div class="section">
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <h2 style="margin-bottom:0;">Household Members</h2>
                        <a href="edit-member.html?householdId=" id="addMemberBtn" class="icon-btn" title="Add Member" style="margin-left:10px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </a>
                    </div>
                    <div id="membersList">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                <!-- Assign Deacon Section -->
                <div class="section">
                    <div style="display:flex;align-items:center;justify-content:space-between;">
                        <h2 style="margin-bottom:0;">Deacon Assignments</h2>
                        <a href="assign-deacons.html?householdId=" id="assignDeaconBtn" class="icon-btn" title="Assign Deacon" style="margin-left:10px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </a>
                    </div>
                    <div id="assignedDeaconsSection" style="margin-top:15px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Member Form -->
    <form id="memberForm" style="display:none;">
        <div class="form-grid">
            <div class="form-group">
                <label for="firstName">First Name *</label>
                <input type="text" id="firstName" name="firstName" required>
            </div>
            <div class="form-group">
                <label for="lastName">Last Name *</label>
                <input type="text" id="lastName" name="lastName" required>
            </div>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label for="relationship">Relationship *</label>
                <select id="relationship" name="relationship" required>
                    <option value="head">Head of Household</option>
                    <option value="spouse">Spouse</option>
                    <option value="child">Child</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="gender">Gender *</label>
                <select id="gender" name="gender" required>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="birthDate">Birth Date</label>
            <input type="date" id="birthDate" name="birthDate">
        </div>
        <div class="form-group">
            <label for="age">Age (if birth date unknown)</label>
            <input type="number" id="age" name="age" min="0" max="150" placeholder="Enter age">
        </div>
        <div class="form-group">
            <label for="phone">Phone</label>
            <input type="tel" id="phone" name="phone">
        </div>
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email">
        </div>
        <div class="form-group">
            <label for="notes">Notes</label>
            <textarea id="notes" name="notes" rows="3"></textarea>
        </div>
        <div class="form-group">
            <label for="tags">Tags</label>
            <div class="tags-container">
                <label class="tag-checkbox">
                    <input type="checkbox" name="tags" value="member"> Member
                </label>
                <label class="tag-checkbox">
                    <input type="checkbox" name="tags" value="attender"> Attender
                </label>
                <label class="tag-checkbox">
                    <input type="checkbox" name="tags" value="in-small-group"> In Small Group
                </label>
                <label class="tag-checkbox">
                    <input type="checkbox" name="tags" value="shut-in"> Shut-in
                </label>
            </div>
        </div>
        <button type="submit" class="btn">Add Member</button>
    </form>
    <!-- End of Member Form -->

    <!-- Edit Member Modal -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content" style="display:none;">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Edit Member</h2>
            <form id="editMemberForm">
                <div id="editMemberError" class="error" style="display: none;"></div>
                <div id="editMemberSuccess" class="success" style="display: none;"></div>
                
                <input type="hidden" id="editMemberId" name="memberId">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editFirstName">First Name *</label>
                        <input type="text" id="editFirstName" name="firstName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editLastName">Last Name *</label>
                        <input type="text" id="editLastName" name="lastName" required>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editRelationship">Relationship *</label>
                        <select id="editRelationship" name="relationship" required>
                            <option value="head">Head of Household</option>
                            <option value="spouse">Spouse</option>
                            <option value="child">Child</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editGender">Gender *</label>
                        <select id="editGender" name="gender" required>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editBirthDate">Birth Date</label>
                        <input type="date" id="editBirthDate" name="birthDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="editAge">Age (if birth date unknown)</label>
                        <input type="number" id="editAge" name="age" min="0" max="150" placeholder="Enter age">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editPhone">Phone</label>
                    <input type="tel" id="editPhone" name="phone">
                </div>
                
                <div class="form-group">
                    <label for="editTags">Tags</label>
                    <div class="tags-container" id="editTagsContainer" style="display:flex;flex-wrap:wrap;gap:10px;">
                        <label class="status-badge tag-checkbox" style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" name="editTags" value="member" style="margin:0;vertical-align:middle;"> Member
                        </label>
                        <label class="status-badge tag-checkbox" style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" name="editTags" value="attender" style="margin:0;vertical-align:middle;"> Attender
                        </label>
                        <label class="status-badge tag-checkbox" style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" name="editTags" value="in-small-group" style="margin:0;vertical-align:middle;"> In Small Group
                        </label>
                        <label class="status-badge tag-checkbox" style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" name="editTags" value="shut-in" style="margin:0;vertical-align:middle;"> Shut-in
                        </label>
                        <label class="status-badge tag-checkbox" style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" name="editTags" value="cancer" style="margin:0;vertical-align:middle;"> Cancer
                        </label>
                        <label class="status-badge tag-checkbox" style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" name="editTags" value="long-term-needs" style="margin:0;vertical-align:middle;"> Long-term Needs
                        </label>
                        <label class="status-badge tag-checkbox" style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" name="editTags" value="widow" style="margin:0;vertical-align:middle;"> Widow
                        </label>
                        <label class="status-badge tag-checkbox" style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" name="editTags" value="widower" style="margin:0;vertical-align:middle;"> Widower
                        </label>
                        <label class="status-badge tag-checkbox" style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" name="editTags" value="married" style="margin:0;vertical-align:middle;"> Married
                        </label>
                        <label class="status-badge tag-checkbox" style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" name="editTags" value="deceased" style="margin:0;vertical-align:middle;"> Deceased
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editEmail">Email</label>
                    <input type="email" id="editEmail" name="email">
                </div>
                
                <div class="form-group">
                    <label for="editNotes">Notes</label>
                    <textarea id="editNotes" name="notes" rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn">Update Member</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            </form>
        </div>
    </div>

    <script type="module">
import { apiFetch } from './fetch-utils.js';

const API_BASE_URL = '';
let currentHouseholdId = null;
let currentHousehold = null;
let currentUser = null;
let currentUserIsDeacon = false;

// Get household ID from URL parameters
function getHouseholdId() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('id');
}

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    currentHouseholdId = getHouseholdId();
    // Load current user (if available) to determine role/tags
    const storedMemberId = (() => { try { return localStorage.getItem('memberId'); } catch(e){ return null; } })();
    if (storedMemberId) {
        apiFetch(`api/members/${storedMemberId}`).then(async res => {
            if (res.ok) {
                const data = await res.json();
                currentUser = data.member || data;
                if (currentUser && Array.isArray(currentUser.tags) && currentUser.tags.includes('deacon')) {
                    currentUserIsDeacon = true;
                }
                // If household data already loaded, re-render members so conditional links appear
                if (currentHouseholdId) {
                    try { loadHouseholdData(); } catch(e) { /* ignore errors */ }
                }
            }
        }).catch(err => console.warn('Failed to load current user', err));
    }
    if (currentHouseholdId) {
        loadHouseholdData();
        loadContactHistory();
    // Set add member link (guarded)
    const addMemberBtn = document.getElementById('addMemberBtn');
    if (addMemberBtn) addMemberBtn.href = `edit-member.html?householdId=${currentHouseholdId}`;
    // Set assign deacon button link (guarded)
    const assignDeaconBtn = document.getElementById('assignDeaconBtn');
    if (assignDeaconBtn) assignDeaconBtn.href = `assign-deacons.html?householdId=${currentHouseholdId}`;
    // Set record contact link (may be created later when contact history is rendered)
    const recordContactAnchor = document.querySelector('a[href="record-contact.html?householdId="]');
    if (recordContactAnchor) recordContactAnchor.href = `record-contact.html?householdId=${currentHouseholdId}`;
    // Set edit household link (guarded)
    const editHouseholdBtn = document.getElementById('editHouseholdBtn');
    if (editHouseholdBtn) editHouseholdBtn.href = `edit-household.html?householdId=${currentHouseholdId}`;
    } else {
        showError('No household ID provided');
    }
});

// Debugging: Log currentHouseholdId
console.log('Current Household ID:', currentHouseholdId);

// Load household data
async function loadHouseholdData() {
    try {
        // Debugging: Log API URLs
        console.log('Fetching households from:', `${API_BASE_URL}/api/households`);
        console.log('Fetching assignments from:', `http://localhost:3001/api/households/${currentHouseholdId}/assignments`);

        const [householdsResponse, assignmentsResponse, membersResponse] = await Promise.all([
            apiFetch(`api/households/${currentHouseholdId}`),
            apiFetch(`api/households/${currentHouseholdId}/assignments`),
            apiFetch(`api/households/${currentHouseholdId}/members`)
        ]);

        const household = await householdsResponse.json();
        let assignmentsData = { assignments: [] };

        // Debugging: Log response status
        console.log('Households Response Status:', householdsResponse.status);
        console.log('Assignments Response Status:', assignmentsResponse.status);
        console.log('Members Response Status:', membersResponse.status);

        if (assignmentsResponse.ok) {
            assignmentsData = await assignmentsResponse.json();
        }

        // Debugging: Log fetched data
        console.log('Households Data:', household);
        console.log('Assignments Data:', assignmentsData);

        const memberData = await membersResponse.json();
        console.log('Members Data:', memberData);

        if (household) {
            currentHousehold = household;
            displayHouseholdInfo(household);
            displayAssignedDeacons(assignmentsData.assignments);
            displayMembers(memberData.members);
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('householdContent').style.display = 'block';
        } else {
            showError('Household not found');
        }
    } catch (error) {
        // Debugging: Log error
        console.error('Error loading household data:', error);
        showError('Error loading household data');
    }
}

// Load contact history
async function loadContactHistory() {
    try {
        const contactsResponse = await apiFetch(`api/households/${currentHouseholdId}/contacts`);
        const contacts = await contactsResponse.json();

        const contactsSection = document.createElement('div');
        contactsSection.className = 'section';
        contactsSection.innerHTML = `
            <div style="display:flex;align-items:center;justify-content:space-between;">
                <h2 style="margin-bottom:0;">Contact History</h2>
                <a href="record-contact.html?householdId=${currentHouseholdId}" class="section-button" title="Record Contact">
                    <span style="font-weight:600;font-size:1em;">Record Contact</span>
                </a>
            </div>
        `;

        if (contacts.count > 0) {
            const contactsTable = document.createElement('table');
            // contactsTable.style.width = '100%';
            // contactsTable.style.borderCollapse = 'collapse';
            contactsTable.className = 'contacts-table';
            contactsTable.innerHTML = `
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #667eea; color: white;">When</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #667eea; color: white;">Who & How</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left; background-color: #667eea; color: white;">Notes</th>
                    </tr>
                </thead>
                <tbody>
                    ${contacts.contacts.map(contact => {
                        const contactDate = contact.contactDate ? new Date(contact.contactDate).toLocaleDateString() : '';
                        let contactedBy = '';
                        switch (contact.contactType) {
                            case 'phone':
                                contactedBy = 'Called';
                                break;
                            case 'visit':
                                contactedBy = 'Visited';
                                break;
                            case 'voicemail':
                                contactedBy = 'Left voicemail';
                                break;
                            case 'church':
                                contactedBy = 'Spoke at church';
                                break;
                        }
                        if (contact.contactedBy?.length) {
                            if (contactedBy) contactedBy += ' by ';
                            contactedBy += contact.contactedBy.map(c => `${c.firstName} ${c.lastName}`).join(', ');
                        }
                        return `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">${contactDate}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${contactedBy}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${contact.summary || 'No notes available'}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
            contactsSection.appendChild(contactsTable);
        } else {
            contactsSection.innerHTML += '<p>No contact history available.</p>';
        }

        document.getElementById('householdContent').appendChild(contactsSection);
    } catch (error) {
        console.error('Error fetching contact history:', error);
    }
}

// Display household information
function displayHouseholdInfo(household) {
    document.getElementById('householdTitle').textContent = `${household.lastName} Household`;
    
    const householdInfo = document.getElementById('householdInfo');
    householdInfo.innerHTML = `
        <h3>${household.lastName} Household</h3>
        <div class="info-grid">
            ${household.address ? `
                <span class="info-label">Address</span>
                <span class="info-value">${household.address.street}${household.address.city ? `<br>${household.address.city}` : ''}${household.address.state ? `, ${household.address.state}` : ''}${household.address.zipCode ? ` ${household.address.zipCode}` : ''}</span>
            ` : ''}
            ${household.primaryPhone ? `
                <span class="info-label">Primary Phone</span>
                <span class="info-value">${household.primaryPhone}</span>
            ` : ''}
            ${household.email ? `
                <span class="info-label">Email</span>
                <span class="info-value">${household.email}</span>
            ` : ''}
        </div>
        ${household.notes ? `
            <div class="info-item">
                <span class="info-label">Notes</span>
                <span class="info-value">${household.notes}</span>
            </div>
        ` : ''}
    `;
}

// Display members
// Display assigned deacons
function displayAssignedDeacons(assignments) {
    const section = document.getElementById('assignedDeaconsSection');
    if (!assignments || assignments.length === 0) {
        section.innerHTML = '<em>No deacons assigned to this household.</em>';
        return;
    }
    // Debugging: Log assignments to verify data structure
    console.log('Assignments:', assignments);
    section.innerHTML = `<strong>Assigned Deacons:</strong> <ul>${assignments.map(a => {
        if (a.deacon && a.deacon.firstName && a.deacon.lastName) {
            return `<li>${a.deacon.firstName} ${a.deacon.lastName}</li>`;
        } else {
            console.warn('Invalid assignment object:', a);
            return '<li>Unknown Deacon</li>';
        }
    }).join('')}</ul>`;
}
function displayMembers(members) {
    const membersList = document.getElementById('membersList');
    if (members.length === 0) {
        membersList.innerHTML = `
            <div class="empty-state">
                <h3>No members added yet</h3>
                <p>Use the button above to add the first member to this household.</p>
            </div>
        `;
        return;
    }
    membersList.innerHTML = members.map(member => `
        <div class="member-card">
            <div class="member-header" style="display:flex;align-items:center;justify-content:space-between;">
                <div class="member-name">${member.firstName} ${member.lastName}</div>
                <div style="display:flex;align-items:center;gap:6px;">
                    ${member.tags && member.tags.length > 0 ? member.tags.map(tag => `<span class="status-badge status-active">${tag}</span>`).join(' ') : ''}
                    ${currentUserIsDeacon && member.tags && member.tags.includes('deacon') ? `
                        <a href="/deacon-quick-contact.html?deaconMemberId=${member._id}" class="icon-btn" title="Quick contact for ${member.firstName} ${member.lastName}" aria-label="Quick contact for ${member.firstName} ${member.lastName}">
                            <span style="font-size:1.1em;color:#22c55e;line-height:1;">ðŸ“ž</span>
                        </a>
                    ` : ''}
                    <a href="edit-member.html?householdId=${member.householdId}&memberId=${member._id}" class="icon-btn" title="Edit Member">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
                    </a>
                </div>
            </div>
            <div class="info-grid">
                <span class="info-label">Relationship</span>
                <span class="info-value">${member.relationship}</span>
                <span class="info-label">Gender</span>
                <span class="info-value">${member.gender}</span>
                ${member.birthDate ? `
                    <span class="info-label">Birth Date</span>
                    <span class="info-value">${new Date(member.birthDate).toLocaleDateString()}</span>
                ` : member.age ? `
                    <span class="info-label">Age</span>
                    <span class="info-value">${member.age}</span>
                ` : ''}
                ${member.phone ? `
                    <span class="info-label">Phone</span>
                    <span class="info-value">${member.phone}</span>
                ` : ''}
                ${member.email ? `
                    <span class="info-label">Email</span>
                    <span class="info-value">${member.email}</span>
                ` : ''}
            </div>
            ${member.notes ? `
                <div class="info-item">
                    <span class="info-label">Notes</span>
                    <span class="info-value">${member.notes}</span>
                </div>
            ` : ''}
        </div>
    `).join('');
}

// Member form submission
document.getElementById('memberForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    // Get tags from checkboxes
    const tags = Array.from(document.querySelectorAll('input[name="tags"]:checked')).map(cb => cb.value);
    
    const memberData = {
        householdId: currentHouseholdId,
        firstName: formData.get('firstName'),
        lastName: formData.get('lastName'),
        relationship: formData.get('relationship'),
        gender: formData.get('gender'),
        phone: formData.get('phone'),
        email: formData.get('email'),
        notes: formData.get('notes'),
        tags: tags
    };
    
    // Add either age or birthDate, but not both
    const birthDate = formData.get('birthDate');
    const age = formData.get('age');
    
    if (birthDate) {
        memberData.birthDate = birthDate;
    } else if (age) {
        memberData.age = parseInt(age);
    }
    
    try {
        const response = await apiFetch(`api/members`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(memberData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showSuccess('memberSuccess', 'Member added successfully!');
            e.target.reset();
            loadHouseholdData();
        } else {
            showError('memberError', result.message || 'Failed to add member');
        }
    } catch (error) {
        showError('memberError', 'Error connecting to server');
    }
});

// Edit member
async function editMember(memberId) {
    try {
        const response = await apiFetch(`api/members`);
        const data = await response.json();
        
        const member = data.members.find(m => m._id === memberId);
        if (!member) {
            alert('Member not found');
            return;
        }
        
        // Populate edit form
        document.getElementById('editMemberId').value = memberId;
        document.getElementById('editFirstName').value = member.firstName;
        document.getElementById('editLastName').value = member.lastName;
        document.getElementById('editRelationship').value = member.relationship;
        document.getElementById('editGender').value = member.gender || '';
        document.getElementById('editBirthDate').value = member.birthDate || '';
        document.getElementById('editAge').value = member.age || '';
        document.getElementById('editPhone').value = member.phone || '';
        document.getElementById('editEmail').value = member.email || '';
        document.getElementById('editNotes').value = member.notes || '';
        
        // Set tags checkboxes
        const tagCheckboxes = document.querySelectorAll('input[name="editTags"]');
        tagCheckboxes.forEach(checkbox => {
            checkbox.checked = member.tags && member.tags.includes(checkbox.value);
        });
        
        // Show modal
        document.getElementById('editMemberModal').style.display = 'block';
    } catch (error) {
        alert('Error loading member data');
    }
}

// Close edit modal
function closeEditModal() {
    document.getElementById('editMemberModal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('editMemberModal');
    if (event.target === modal) {
        closeEditModal();
    }
}

// Edit member form submission
document.getElementById('editMemberForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const memberId = formData.get('memberId');
    
    // Get tags from checkboxes
    const tags = Array.from(document.querySelectorAll('input[name="editTags"]:checked')).map(cb => cb.value);
    
    const memberData = {
        firstName: formData.get('firstName'),
        lastName: formData.get('lastName'),
        relationship: formData.get('relationship'),
        gender: formData.get('gender'),
        phone: formData.get('phone'),
        email: formData.get('email'),
        notes: formData.get('notes'),
        tags: tags
    };
    
    // Add either age or birthDate, but not both
    const birthDate = formData.get('birthDate');
    const age = formData.get('age');
    
    if (birthDate) {
        memberData.birthDate = birthDate;
    } else if (age) {
        memberData.age = parseInt(age);
    }
    
    try {
        const response = await apiFetch(`api/members/${memberId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(memberData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showSuccess('editMemberSuccess', 'Member updated successfully!');
            setTimeout(() => {
                closeEditModal();
                loadHouseholdData();
            }, 1500);
        } else {
            showError('editMemberError', result.message || 'Failed to update member');
        }
    } catch (error) {
        showError('editMemberError', 'Error connecting to server');
    }
});

// Utility functions
function showError(elementId, message) {
    if (typeof elementId === 'string' && elementId.includes('Error')) {
        const element = document.getElementById(elementId);
        if (element) {
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
    } else {
        // Show general error
        document.getElementById('loadingState').innerHTML = `
            <div class="empty-state">
                <h3>Error</h3>
                <p>${elementId}</p>
                <button class="btn" onclick="location.reload()">Retry</button>
            </div>
        `;
    }
}

function showSuccess(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = message;
        element.style.display = 'block';
        setTimeout(() => {
            element.style.display = 'none';
        }, 5000);
    }
}
    </script>
</body>
</html>
