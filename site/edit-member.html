<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add/Edit Member - Deacon Care System</title>
    <link rel="stylesheet" href="site.css">
</head>
<body>
        <!-- Reusable navigation bar -->
        <div id="site-nav-container"></div>
        <script>
        // Polyfill Array.from for older browsers
        if (!Array.from) {
            Array.from = function(arrayLike) {
                return Array.prototype.slice.call(arrayLike);
            };
        }
        </script>
    <div class="container" style="margin-top:60px; max-width:600px;">
        <h1 id="formTitle">Add Member</h1>
        <form id="memberForm">
            <div id="formError" class="error" style="display:none;"></div>
            <div id="formSuccess" class="success" style="display:none;"></div>
            <input type="hidden" id="memberId" name="memberId">
            <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" name="firstName" required>
            </div>
            <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" name="lastName" required>
            </div>
            <div class="form-group">
                <label for="phone">Phone</label>
                <input type="text" id="phone" name="phone">
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email">
            </div>
            <div class="form-group">
                <label for="gender">Gender</label>
                <select id="gender" name="gender" required>
                    <option value="">Select</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            <div class="form-group">
                <label for="relationship">Relationship</label>
                <select id="relationship" name="relationship" required>
                    <option value="head">Head</option>
                    <option value="spouse">Spouse</option>
                    <option value="child">Child</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tags</label>
                <div class="tag-checkboxes">
                    <label class="status-badge"><input type="checkbox" name="tags" value="deacon">Deacon</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="deaconess">Deaconess</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="elder">Elder</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="staff">Staff</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="member">Member</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="attender">Attender</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="in-small-group">In Small Group</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="shut-in">Shut-in</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="cancer">Cancer</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="long-term-needs">Long-term Needs</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="deceased">Deceased</label>
                </div>
            </div>

            <!-- Temporary Address Section -->
            <div style="border-top: 2px solid #ddd; margin-top: 30px; padding-top: 20px;">
                <h3 style="margin-top: 0;">Temporary Location (Optional)</h3>
                <p style="color: #666; font-size: 0.9em;">Track when this member is at a temporary location (hospital, nursing home, etc.)</p>
                
                <div class="form-group">
                    <label for="tempLocationDropdown">Select Common Location</label>
                    <select id="tempLocationDropdown">
                        <option value="">-- Select from common locations --</option>
                    </select>
                </div>

                <div id="tempLocationDisplay" style="display: none; background: #f5f5f5; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                    <p style="margin: 0 0 8px 0;"><strong id="tempLocationName"></strong></p>
                    <p id="tempLocationAddress" style="margin: 0; color: #666; font-size: 0.9em;"></p>
                </div>

                <div class="form-group">
                    <label for="tempRoomNumber">Room/Unit Number</label>
                    <input type="text" id="tempRoomNumber" placeholder="e.g., Room 312 or Unit B-14">
                </div>

                <div class="form-group">
                    <label for="tempNotes">Notes</label>
                    <textarea id="tempNotes" rows="3" placeholder="e.g., Post-surgery recovery, expected discharge Feb 15"></textarea>
                </div>

                <div class="form-group" style="margin-top: 15px;">
                    <button type="button" id="clearTempBtn" class="btn btn-secondary" style="width: 100%;">Clear Temporary Location</button>
                </div>
            </div>

            <button class="btn section-button" type="submit" id="saveBtn">Save Member</button>
            <a href="#" class="btn btn-secondary" id="cancelBtn">Cancel</a>
        </form>
    </div>
    <script type="module">
    import { apiFetch } from './fetch-utils.js';

    // Get memberId and householdId from query params
    function getParams() {
        var urlParams = new URLSearchParams(window.location.search);
        return {
            memberId: urlParams.get('memberId'),
            householdId: urlParams.get('householdId')
        };
    }
    var params = getParams();
    var memberId = params.memberId;
    var householdId = params.householdId;

    // Store selected location data
    var selectedLocation = null;
    var selectedLocationId = null;
    var existingTemporaryAddress = null;
    var wasExistingLocationPreselected = false;

    // Consolidated DOMContentLoaded listener
    document.addEventListener('DOMContentLoaded', function() {
        // Load reusable navigation bar
        var navContainer = document.getElementById('site-nav-container');
        if (navContainer) {
            fetch('site-nav.html')
                .then(function(navResp) {
                    if (navResp.ok) {
                        return navResp.text();
                    }
                    throw new Error('Failed to load navigation');
                })
                .then(function(navHtml) {
                    navContainer.innerHTML = navHtml;
                    var script = document.createElement('script');
                    script.src = 'site-nav.js';
                    document.body.appendChild(script);
                })
                .catch(function(error) {
                    console.error('Error loading navigation:', error);
                });
        }

        // Tag badge checked/unchecked state toggle
        function updateTagBadges() {
            var labels = document.querySelectorAll('.tag-badge');
            for (var i = 0; i < labels.length; i++) {
                var label = labels[i];
                var cb = label.querySelector('input[type="checkbox"]');
                if (cb && cb.checked) {
                    label.classList.remove('tag-unchecked');
                } else {
                    label.classList.add('tag-unchecked');
                }
            }
        }
        var tagCheckboxes = document.querySelectorAll('.tag-badge input[type="checkbox"]');
        for (var j = 0; j < tagCheckboxes.length; j++) {
            tagCheckboxes[j].addEventListener('change', updateTagBadges);
        }
        updateTagBadges();

        // Clear temporary location button
        document.getElementById('clearTempBtn').addEventListener('click', function(e) {
            e.preventDefault();
            clearTemporaryLocationFields();
        });

        // Load common locations first, then load member data if editing
        loadCommonLocations().then(function() {
            // If editing, load member data
            if (memberId) {
                document.getElementById('formTitle').textContent = 'Edit Member';
                apiFetch('api/members/' + memberId)
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        var member = data.member || data;
                        console.log('Loaded member:', member);
                        document.getElementById('memberId').value = member._id || '';
                        document.getElementById('firstName').value = member.firstName || '';
                        document.getElementById('lastName').value = member.lastName || '';
                        document.getElementById('phone').value = member.phone || '';
                        document.getElementById('email').value = member.email || '';
                        document.getElementById('gender').value = member.gender || '';
                        document.getElementById('relationship').value = member.relationship || '';
                        // Set tags
                        var tags = member.tags || [];
                        var tagInputs = Array.from(document.querySelectorAll('input[name="tags"]'));
                        for (var k = 0; k < tagInputs.length; k++) {
                            var cb = tagInputs[k];
                            cb.checked = tags.indexOf(cb.value) !== -1;
                        }
                        // Load temporary address if exists
                        if (member.temporaryAddress && member.temporaryAddress.locationId) {
                            loadTemporaryLocation(member.temporaryAddress);
                        }
                    })
                    .catch(function() {
                        document.getElementById('formError').textContent = 'Could not load member data.';
                        document.getElementById('formError').style.display = 'block';
                    });
            }
        }).catch(function(error) {
            console.error('Error loading common locations:', error);
        });
    });

    // Load common locations from static JSON file
    async function loadCommonLocations() {
        try {
            // Fetch locations from API (which has the database IDs)
            const response = await apiFetch('/api/common-locations');
            const data = await response.json();
            const locations = data.locations || [];
            
            console.log('Loaded locations from API:', locations);
            
            const dropdown = document.getElementById('tempLocationDropdown');
            locations.forEach(function(location) {
                const option = document.createElement('option');
                option.value = location.name; // Use name as key for display
                option.textContent = location.name + ' (' + location.type + ')';
                option.dataset.locationId = location._id; // Store database ID
                option.dataset.location = JSON.stringify(location);
                console.log('Adding location option:', {
                    name: location.name,
                    _id: location._id,
                    type: location.type
                });
                dropdown.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading common locations:', error);
        }
    }

    // Handle location selection from dropdown
    document.getElementById('tempLocationDropdown').addEventListener('change', function(e) {
        if (this.value) {
            const selectedOption = this.options[this.selectedIndex];
            selectedLocation = JSON.parse(selectedOption.dataset.location);
            selectedLocationId = selectedOption.dataset.locationId;
            wasExistingLocationPreselected = false;  // User just selected a new location
            
            console.log('Location selected:', {
                name: this.value,
                locationId: selectedLocationId,
                location: selectedLocation
            });
            
            // Display location info
            const display = document.getElementById('tempLocationDisplay');
            const name = document.getElementById('tempLocationName');
            const addr = document.getElementById('tempLocationAddress');
            
            name.textContent = selectedLocation.name;
            const addrParts = [
                selectedLocation.address?.street,
                selectedLocation.address?.city + ', ' + selectedLocation.address?.state,
                selectedLocation.address?.zipCode
            ].filter(Boolean);
            addr.textContent = addrParts.join(' â€¢ ');
            display.style.display = 'block';
            
            // Auto-focus room number field
            document.getElementById('tempRoomNumber').focus();
        } else {
            selectedLocation = null;
            selectedLocationId = null;
            wasExistingLocationPreselected = false;
            document.getElementById('tempLocationDisplay').style.display = 'none';
        }
    });

    // Load existing temporary location into form
    function loadTemporaryLocation(tempAddr) {
        existingTemporaryAddress = tempAddr;
        document.getElementById('tempRoomNumber').value = tempAddr.roomNumber || '';
        document.getElementById('tempNotes').value = tempAddr.notes || '';
        
        // Set selectedLocationId from the existing data but mark that it was pre-selected
        selectedLocationId = tempAddr.locationId;
        wasExistingLocationPreselected = true;
        
        // Try to find and select the location in dropdown
        if (tempAddr.locationId) {
            const dropdown = document.getElementById('tempLocationDropdown');
            for (let i = 0; i < dropdown.options.length; i++) {
                if (dropdown.options[i].dataset.locationId === tempAddr.locationId) {
                    dropdown.selectedIndex = i;
                    dropdown.dispatchEvent(new Event('change'));
                    break;
                }
            }
        }
    }

    // Clear temporary location fields
    function clearTemporaryLocationFields() {
        document.getElementById('tempLocationDropdown').value = '';
        document.getElementById('tempLocationDisplay').style.display = 'none';
        document.getElementById('tempRoomNumber').value = '';
        document.getElementById('tempNotes').value = '';
        selectedLocation = null;
        selectedLocationId = null;
        existingTemporaryAddress = null;
        wasExistingLocationPreselected = false;
    }

    // Save handler
    document.getElementById('memberForm').onsubmit = function(e) {
        e.preventDefault();
        var form = e.target;
        var checkedTags = Array.from(form.querySelectorAll('input[name="tags"]:checked'));
        var tagValues = [];
        for (var i = 0; i < checkedTags.length; i++) {
            tagValues.push(checkedTags[i].value);
        }
        
        var member = {
            firstName: form.firstName.value,
            lastName: form.lastName.value,
            phone: form.phone.value,
            email: form.email.value,
            gender: form.gender.value,
            relationship: form.relationship.value,
            tags: tagValues
        };

        // Add temporary address based on what happened with location selection
        if (selectedLocationId && !wasExistingLocationPreselected) {
            // New location just selected by user
            member.temporaryAddress = {
                locationId: selectedLocationId,
                roomNumber: document.getElementById('tempRoomNumber').value || undefined,
                startDate: new Date().toISOString().split('T')[0],
                notes: document.getElementById('tempNotes').value || undefined,
                isActive: true
            };
            // Remove undefined properties
            Object.keys(member.temporaryAddress).forEach(key => 
                member.temporaryAddress[key] === undefined && delete member.temporaryAddress[key]
            );
            console.log('Sending temporaryAddress (new location):', member.temporaryAddress);
        } else if (selectedLocationId && wasExistingLocationPreselected && existingTemporaryAddress) {
            // Existing location loaded, user just editing notes/room
            member.temporaryAddress = {
                locationId: existingTemporaryAddress.locationId,
                roomNumber: document.getElementById('tempRoomNumber').value || undefined,
                startDate: existingTemporaryAddress.startDate,
                notes: document.getElementById('tempNotes').value || undefined,
                isActive: true
            };
            // Remove undefined properties
            Object.keys(member.temporaryAddress).forEach(key => 
                member.temporaryAddress[key] === undefined && delete member.temporaryAddress[key]
            );
            console.log('Sending temporaryAddress (existing updated):', member.temporaryAddress);
        } else if (memberId && !selectedLocationId && document.getElementById('tempLocationDropdown').value === '') {
            // Explicitly cleared existing temporary location
            member.temporaryAddress = {
                isActive: false,
                endDate: new Date().toISOString().split('T')[0]
            };
            console.log('Sending temporaryAddress (cleared):', member.temporaryAddress);
        }

        var url = '/api/members';
        var method = 'POST';
        if (memberId) {
            url = '/api/members/' + memberId;
            method = 'PUT';
        } else {
            // For new member, need householdId
            member.householdId = householdId;
        }
        
        console.log('Saving member data:', member);
        apiFetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(member)
        })
        .then(function(res) {
            if (res.ok) {
                document.getElementById('formSuccess').style.display = 'block';
                return res.json().then(function(data) {
                    // Use householdId from API response if available
                    var redirectHouseholdId = data.member && data.member.householdId ? data.member.householdId : householdId;
                    setTimeout(function() {
                        window.location.href = 'household.html?id=' + redirectHouseholdId;
                    }, 800);
                });
            } else {
                return res.json().then(function(data) {
                    console.error('API error response:', data);
                    document.getElementById('formError').textContent = data.message || 'Error saving member.';
                    document.getElementById('formError').style.display = 'block';
                });
            }
        })
        .catch(function(err) {
            console.error('Error saving member:', err);
            document.getElementById('formError').textContent = 'Error saving member.';
            document.getElementById('formError').style.display = 'block';
        });
    };
    // Cancel handler
    document.getElementById('cancelBtn').onclick = function(e) {
        e.preventDefault();
        window.location.href = 'household.html?id=' + householdId;
    };
    </script>
    <script src="redirect-handler.js"></script>
</body>
</html>
