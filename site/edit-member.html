<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add/Edit Member - Deacon Care System</title>
    <link rel="stylesheet" href="site.css">
</head>
<body>
        <!-- Reusable navigation bar -->
        <div id="site-nav-container"></div>
        <script>
        // Polyfill Array.from for older browsers
        if (!Array.from) {
            Array.from = function(arrayLike) {
                return Array.prototype.slice.call(arrayLike);
            };
        }
        </script>
    <div class="container" style="margin-top:60px; max-width:600px;">
        <h1 id="formTitle">Add Member</h1>
        <form id="memberForm">
            <div id="formError" class="error" style="display:none;"></div>
            <div id="formSuccess" class="success" style="display:none;"></div>
            <input type="hidden" id="memberId" name="memberId">
            <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" name="firstName" required>
            </div>
            <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" name="lastName" required>
            </div>
            <div class="form-group">
                <label for="phone">Phone</label>
                <input type="text" id="phone" name="phone">
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email">
            </div>
            <div class="form-group">
                <label for="gender">Gender</label>
                <select id="gender" name="gender" required>
                    <option value="">Select</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            <div class="form-group">
                <label for="relationship">Relationship</label>
                <select id="relationship" name="relationship" required>
                    <option value="head">Head</option>
                    <option value="spouse">Spouse</option>
                    <option value="child">Child</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tags</label>
                <div class="tag-checkboxes">
                    <label class="status-badge"><input type="checkbox" name="tags" value="deacon">Deacon</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="deaconess">Deaconess</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="elder">Elder</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="staff">Staff</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="member">Member</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="attender">Attender</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="in-small-group">In Small Group</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="shut-in">Shut-in</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="cancer">Cancer</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="long-term-needs">Long-term Needs</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="deceased">Deceased</label>
                </div>
            </div>
            <button class="btn section-button" type="submit" id="saveBtn">Save Member</button>
            <a href="#" class="btn btn-secondary" id="cancelBtn">Cancel</a>
        </form>
    </div>
    <script type="module">
    import { apiFetch } from './fetch-utils.js';

    // Get memberId and householdId from query params
    function getParams() {
        var urlParams = new URLSearchParams(window.location.search);
        return {
            memberId: urlParams.get('memberId'),
            householdId: urlParams.get('householdId')
        };
    }
    var params = getParams();
    var memberId = params.memberId;
    var householdId = params.householdId;

    // Consolidated DOMContentLoaded listener
    document.addEventListener('DOMContentLoaded', function() {
        // Load reusable navigation bar
        var navContainer = document.getElementById('site-nav-container');
        if (navContainer) {
            fetch('site-nav.html')
                .then(function(navResp) {
                    if (navResp.ok) {
                        return navResp.text();
                    }
                    throw new Error('Failed to load navigation');
                })
                .then(function(navHtml) {
                    navContainer.innerHTML = navHtml;
                    var script = document.createElement('script');
                    script.src = 'site-nav.js';
                    document.body.appendChild(script);
                })
                .catch(function(error) {
                    console.error('Error loading navigation:', error);
                });
        }

        // Tag badge checked/unchecked state toggle
        function updateTagBadges() {
            var labels = document.querySelectorAll('.tag-badge');
            for (var i = 0; i < labels.length; i++) {
                var label = labels[i];
                var cb = label.querySelector('input[type="checkbox"]');
                if (cb && cb.checked) {
                    label.classList.remove('tag-unchecked');
                } else {
                    label.classList.add('tag-unchecked');
                }
            }
        }
        var tagCheckboxes = document.querySelectorAll('.tag-badge input[type="checkbox"]');
        for (var j = 0; j < tagCheckboxes.length; j++) {
            tagCheckboxes[j].addEventListener('change', updateTagBadges);
        }
        updateTagBadges();

        // If editing, load member data
        if (memberId) {
            document.getElementById('formTitle').textContent = 'Edit Member';
            apiFetch('api/members/' + memberId)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    var member = data.member || data;
                    console.log('Loaded member:', member);
                    document.getElementById('memberId').value = member._id || '';
                    document.getElementById('firstName').value = member.firstName || '';
                    document.getElementById('lastName').value = member.lastName || '';
                    document.getElementById('phone').value = member.phone || '';
                    document.getElementById('email').value = member.email || '';
                    document.getElementById('gender').value = member.gender || '';
                    document.getElementById('relationship').value = member.relationship || '';
                    // Set tags
                    var tags = member.tags || [];
                    var tagInputs = Array.from(document.querySelectorAll('input[name="tags"]'));
                    for (var k = 0; k < tagInputs.length; k++) {
                        var cb = tagInputs[k];
                        cb.checked = tags.indexOf(cb.value) !== -1;
                    }
                })
                .catch(function() {
                    document.getElementById('formError').textContent = 'Could not load member data.';
                    document.getElementById('formError').style.display = 'block';
                });
        }
    });
    // Save handler
    document.getElementById('memberForm').onsubmit = function(e) {
        e.preventDefault();
        var form = e.target;
        var checkedTags = Array.from(form.querySelectorAll('input[name="tags"]:checked'));
        var tagValues = [];
        for (var i = 0; i < checkedTags.length; i++) {
            tagValues.push(checkedTags[i].value);
        }
        
        var member = {
            firstName: form.firstName.value,
            lastName: form.lastName.value,
            phone: form.phone.value,
            email: form.email.value,
            gender: form.gender.value,
            relationship: form.relationship.value,
            tags: tagValues
        };
        var url = '/api/members';
        var method = 'POST';
        if (memberId) {
            url = '/api/members/' + memberId;
            method = 'PUT';
        } else {
            // For new member, need householdId
            member.householdId = householdId;
        }
        
        apiFetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(member)
        })
        .then(function(res) {
            if (res.ok) {
                document.getElementById('formSuccess').style.display = 'block';
                return res.json().then(function(data) {
                    // Use householdId from API response if available
                    var redirectHouseholdId = data.member && data.member.householdId ? data.member.householdId : householdId;
                    setTimeout(function() {
                        window.location.href = 'household.html?id=' + redirectHouseholdId;
                    }, 800);
                });
            } else {
                return res.json().then(function(data) {
                    document.getElementById('formError').textContent = data.message || 'Error saving member.';
                    document.getElementById('formError').style.display = 'block';
                });
            }
        })
        .catch(function(err) {
            console.error('Error saving member:', err);
            document.getElementById('formError').textContent = 'Error saving member.';
            document.getElementById('formError').style.display = 'block';
        });
    };
    // Cancel handler
    document.getElementById('cancelBtn').onclick = function(e) {
        e.preventDefault();
        window.location.href = 'household.html?id=' + householdId;
    };
    </script>
    <script src="redirect-handler.js"></script>
</body>
</html>
