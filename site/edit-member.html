<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add/Edit Member - Deacon Care System</title>
    <link rel="stylesheet" href="site.css">
</head>
<body>
    <!-- Navigation Bar -->
    <div id="siteNavContainer"></div>
    <script>
      // Load nav bar
      fetch('site-nav.html').then(r => r.text()).then(html => {
        document.getElementById('siteNavContainer').innerHTML = html;
      });
    </script>
    <div class="container" style="margin-top:60px; max-width:600px;">
        <h1 id="formTitle">Add Member</h1>
        <form id="memberForm">
            <div id="formError" class="error" style="display:none;"></div>
            <div id="formSuccess" class="success" style="display:none;"></div>
            <input type="hidden" id="memberId" name="memberId">
            <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" name="firstName" required>
            </div>
            <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" name="lastName" required>
            </div>
            <div class="form-group">
                <label for="phone">Phone</label>
                <input type="text" id="phone" name="phone">
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email">
            </div>
            <div class="form-group">
                <label for="gender">Gender</label>
                <select id="gender" name="gender" required>
                    <option value="">Select</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>
            </div>
            <div class="form-group">
                <label for="relationship">Relationship</label>
                <select id="relationship" name="relationship" required>
                    <option value="head">Head</option>
                    <option value="spouse">Spouse</option>
                    <option value="child">Child</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tags</label>
                <div class="tag-checkboxes">
                    <label class="status-badge"><input type="checkbox" name="tags" value="deacon">Deacon</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="deaconess">Deaconess</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="elder">Elder</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="staff">Staff</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="member">Member</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="attender">Attender</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="shut-in">Shut-in</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="cancer">Cancer</label>
                    <label class="status-badge"><input type="checkbox" name="tags" value="long-term-needs">Long-term Needs</label>
                </div>
            </div>
            <button class="btn section-button" type="submit" id="saveBtn">Save Member</button>
            <a href="#" class="btn btn-secondary" id="cancelBtn">Cancel</a>
        </form>
    </div>
    <script type="module">
    // Tag badge checked state toggle
    document.addEventListener('DOMContentLoaded', function() {
        function updateTagBadges() {
            document.querySelectorAll('.tag-badge').forEach(label => {
                const cb = label.querySelector('input[type="checkbox"]');
                if (cb && cb.checked) {
                    label.classList.add('checked');
                } else {
                    label.classList.remove('checked');
                }
            });
        }
        document.querySelectorAll('.tag-badge input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', updateTagBadges);
        });
        updateTagBadges();
    });
    import { apiFetch } from './fetch-utils.js';

    // Get memberId and householdId from query params
    function getParams() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
            memberId: urlParams.get('memberId'),
            householdId: urlParams.get('householdId')
        };
    }
    const { memberId, householdId } = getParams();
    // If editing, load member data after DOM is ready
    if (memberId) {
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('formTitle').textContent = 'Edit Member';
            apiFetch(`api/members/${memberId}`)
                .then(response => response.json())
                .then(data => {
                    const member = data.member || data;
                    console.log('Loaded member:', member);
                    document.getElementById('memberId').value = member._id || '';
                    document.getElementById('firstName').value = member.firstName || '';
                    document.getElementById('lastName').value = member.lastName || '';
                    document.getElementById('phone').value = member.phone || '';
                    document.getElementById('email').value = member.email || '';
                    document.getElementById('gender').value = member.gender || '';
                    document.getElementById('relationship').value = member.relationship || '';
                    // Set tags
                    var tags = member.tags || [];
                    Array.from(document.querySelectorAll('input[name="tags"]')).forEach(cb => {
                        cb.checked = tags.includes(cb.value);
                    });
                })
                .catch(() => {
                    document.getElementById('formError').textContent = 'Could not load member data.';
                    document.getElementById('formError').style.display = 'block';
                });
        });
    }
    // Save handler
    document.getElementById('memberForm').onsubmit = async function(e) {
        e.preventDefault();
        const form = e.target;
        const member = {
            firstName: form.firstName.value,
            lastName: form.lastName.value,
            phone: form.phone.value,
            email: form.email.value,
            gender: form.gender.value,
            relationship: form.relationship.value,
            tags: Array.from(form.querySelectorAll('input[name="tags"]:checked')).map(cb => cb.value)
        };
        let url = '/api/members';
        let method = 'POST';
        if (memberId) {
            url = `/api/members/${memberId}`;
            method = 'PUT';
        } else {
            // For new member, need householdId
            member.householdId = householdId;
        }
        try {
            const res = await apiFetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(member)
            });
            if (res.ok) {
                document.getElementById('formSuccess').style.display = 'block';
                const data = await res.json();
                // Use householdId from API response if available
                const redirectHouseholdId = data.member && data.member.householdId ? data.member.householdId : householdId;
                setTimeout(() => {
                    window.location.href = `household.html?id=${redirectHouseholdId}`;
                }, 800);
            } else {
                const data = await res.json();
                document.getElementById('formError').textContent = data.message || 'Error saving member.';
                document.getElementById('formError').style.display = 'block';
            }
        } catch (err) {
            document.getElementById('formError').textContent = 'Error saving member.';
            document.getElementById('formError').style.display = 'block';
        }
    };
    // Cancel handler
    document.getElementById('cancelBtn').onclick = function(e) {
        e.preventDefault();
        window.location.href = `household.html?id=${householdId}`;
    };
    </script>
    <script src="redirect-handler.js"></script>
</body>
</html>
