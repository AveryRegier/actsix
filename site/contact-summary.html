<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Summary Report</title>
    <link rel="stylesheet" href="site.css">
    <!-- print.css lives in the same folder as this HTML file, use relative path -->
    <link rel="stylesheet" href="print.css" media="print">
</head>
<body>
    <div class="container">
        <!-- Reusable navigation bar -->
        <div id="site-nav-container"></div>
        <div class="header">
            <h1 style="display:flex;align-items:center;justify-content:center;font-size:1.3em;font-weight:400;gap:0.5em;">
                <span style="font-size:1.1em;">ðŸ“‹</span>
                Contact Summary Report
            </h1>
        </div>
        <table id="summaryTable" class="summary-table">
            <thead>
                <tr>
                    <th colspan="2">Name</th>
                    <th colspan="2">Assignment</th>
                    <th colspan="2">Last Contact</th>
                    <!-- print-only Notes header to align the Notes column in print; hidden on screen via inline style -->
                    <th rowspan="2" class="notes-col print-only" style="display:none">Summary</th>
                </tr>
                <tr>
                    <th>Last</th>
                    <th>First</th>
                    <th>Make Contact</th>
                    <th>Deacons</th>
                    <th>When</th>
                    <th>Who & How</th>
                    
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <script type="module">
        import { apiFetch } from './fetch-utils.js';
        import { getBestContactMethod, getContactedBy, getContactDateClass } from './contact-utils.js';
        import { formatAddressForDisplay, formatAddressForMaps } from './address-utils.js';

        // Load reusable navigation bar
        document.addEventListener('DOMContentLoaded', async () => {
            const navContainer = document.getElementById('site-nav-container');
            if (navContainer) {
                const navResp = await fetch('site-nav.html');
                if (navResp.ok) {
                    navContainer.innerHTML = await navResp.text();
                    const script = document.createElement('script');
                    script.src = 'site-nav.js';
                    document.body.appendChild(script);
                }
            }
        });

        async function fetchSummary() {
            const response = await apiFetch('api/reports/summary');
            const data = await response.json();
            const tableBody = document.getElementById('summaryTable').querySelector('tbody');

            data.summary.sort((a, b) => a.household.lastName.localeCompare(b.household.lastName));

            tableBody.innerHTML = data.summary.map((item, idx) => {
                const currentHouseholdId = item.household._id;
                const householdName = item.household?.members?.map(m => m.firstName).join(' & ');

                const phoneNumbers = getBestContactMethod(item.household);
                const deacons = item.assignedDeacons?.map(d => `${d.firstName} ${d.lastName}`).join(', ') || "(Assign)";
                const lastContactDate = item.lastContact?.contactDate ? new Date(item.lastContact.contactDate) : null;

                const contactedBy = getContactedBy(item.lastContact);
                let contactDateClass = getContactDateClass(lastContactDate);

                // Find any member with an active temporary location
                let tempMember = null;
                if (item.household.members && item.household.members.length > 0) {
                    for (const member of item.household.members) {
                        if (member.temporaryAddress && member.temporaryAddress.isActive && member.temporaryAddress.locationId) {
                            tempMember = member;
                            break;
                        }
                    }
                }

                const rowClass = idx % 2 === 0 ? 'even' : 'odd';
                const summaryContent = `${item.summary}`;
                
                return `
                    <tr class="summary-row ${rowClass}" data-household-id="${currentHouseholdId}">
                        <td class="summary-badge-col">
                            <a class="member-link" href="household.html?id=${currentHouseholdId}">${item.household.lastName}</a>
                            <span class="cell-badge">Last</span>
                        </td>
                        <td class="summary-badge-col">
                            <a class="member-link" href="household.html?id=${currentHouseholdId}">${householdName}</a>
                            <span class="cell-badge">First</span>
                        </td>
                        <td class="summary-badge-col">
                            <a href="record-contact.html?householdId=${currentHouseholdId}">${phoneNumbers}</a>
                            <span class="cell-badge">Make Contact</span>
                        </td>
                        <td class="summary-badge-col">
                            <a href="assign-deacons.html?householdId=${currentHouseholdId}">${deacons}</a>
                            <span class="cell-badge">Deacons</span>
                        </td>
                        <td class="last-contact-col ${contactDateClass}">
                            ${lastContactDate ? lastContactDate.toLocaleDateString() : '(needed)'}
                            <span class="cell-badge">When</span>
                        </td>
                        <td class="last-contact-col">
                            ${contactedBy}
                            <span class="cell-badge">Who & How</span>
                        </td>
                        <td class="last-contact-col notes-col" data-household-id="${currentHouseholdId}">
                            ${summaryContent}
                            <div class="temp-location-info" style="margin-top: 8px;"></div>
                            <span class="cell-badge">Summary</span>
                        </td>
                    </tr>
                `;
            }).join('');

            // Now fetch and display temporary locations if any exist
            const tempLocationFetches = [];
            data.summary.forEach(item => {
                if (item.household.members && item.household.members.length > 0) {
                    for (const member of item.household.members) {
                        if (member.temporaryAddress && member.temporaryAddress.isActive && member.temporaryAddress.locationId) {
                            tempLocationFetches.push({
                                householdId: item.household._id,
                                locationId: member.temporaryAddress.locationId,
                                roomNumber: member.temporaryAddress.roomNumber,
                                startDate: member.temporaryAddress.startDate,
                                notes: member.temporaryAddress.notes
                            });
                            break;  // Only process first member with temp location per household
                        }
                    }
                }
            });

            tempLocationFetches.forEach(fetchInfo => {
                apiFetch('api/common-locations/' + fetchInfo.locationId)
                    .then(res => res.json())
                    .then(data => {
                        const location = data.location;
                        if (location && location.address) {
                            const mapsUrl = formatAddressForMaps(location.address);
                            const displayAddress = formatAddressForDisplay(location.address, false);
                            const roomInfo = fetchInfo.roomNumber ? ' â€¢ Room/Unit: ' + fetchInfo.roomNumber : '';
                            const selector = `td[data-household-id="${fetchInfo.householdId}"] .temp-location-info`;
                            const locElement = document.querySelector(selector);
                            if (locElement) {
                                let html = '<div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 10px; margin-top: 10px;">' +
                                    '<strong style="color: #856404;">Temporary Location:</strong>' +
                                    '<div style="margin-top: 5px;">' +
                                    '<span style="color: #333;">' + location.name + roomInfo + '</span>' +
                                    '</div>' +
                                    '<div style="margin-top: 3px; font-size: 0.9em;">' +
                                    '<a href="' + mapsUrl + '" target="_blank" rel="noopener noreferrer" style="color: #0066cc; text-decoration: none;">' + displayAddress + '</a>' +
                                    '</div>';
                                if (fetchInfo.startDate) {
                                    html += '<div style="margin-top: 3px; font-size: 0.85em; color: #666;">Since: ' + new Date(fetchInfo.startDate).toLocaleDateString() + '</div>';
                                }
                                if (fetchInfo.notes) {
                                    html += '<div style="margin-top: 5px; font-size: 0.9em; font-style: italic; color: #555;">' + fetchInfo.notes + '</div>';
                                }
                                html += '</div>';
                                locElement.innerHTML = html;
                            }
                        }
                    })
                    .catch(err => console.error('Error fetching location:', err));
            });
        }

        

        document.addEventListener('DOMContentLoaded', fetchSummary);
    </script>
    <script>
        // Inject a print-only colgroup just before printing and remove it after.
        // This avoids changing the on-screen layout while giving the print renderer
        // explicit column widths to align headers and body.
        (function() {
            const colgroupId = 'print-colgroup';
            const widths = ['10%','10%','11.5%','11%','7.5%','7%','43%'];

            function createColGroup() {
                if (document.getElementById(colgroupId)) return;
                const table = document.getElementById('summaryTable');
                if (!table) return;
                const cg = document.createElement('colgroup');
                cg.id = colgroupId;
                widths.forEach(w => {
                    const c = document.createElement('col');
                    c.style.width = w;
                    cg.appendChild(c);
                });
                // Insert as first child of the table so it affects layout
                table.insertBefore(cg, table.firstChild);
            }

            function removeColGroup() {
                const cg = document.getElementById(colgroupId);
                if (cg) cg.remove();
            }

            // Modern browsers: matchMedia for print
            if (window.matchMedia) {
                const m = window.matchMedia('print');
                try { m.addListener(e => { if (e.matches) createColGroup(); else removeColGroup(); }); } catch (e) {}
            }

            // fallback: beforeprint/afterprint events
            window.addEventListener('beforeprint', createColGroup);
            window.addEventListener('afterprint', removeColGroup);

            // Safety: remove if page is navigated or on load complete
            window.addEventListener('pageshow', removeColGroup);
            window.addEventListener('DOMContentLoaded', removeColGroup);
        })();
    </script>
</body>
</html>
