<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Summary Report</title>
    <link rel="stylesheet" href="site.css">
    <!-- print.css lives in the same folder as this HTML file, use relative path -->
    <link rel="stylesheet" href="print.css" media="print">
</head>
<body>
    <div class="container">
        <!-- Reusable navigation bar -->
        <div id="site-nav-container"></div>
        <div class="header">
            <h1 style="display:flex;align-items:center;justify-content:center;font-size:1.3em;font-weight:400;gap:0.5em;">
                <span style="font-size:1.1em;">ðŸ“‹</span>
                Contact Summary Report
            </h1>
        </div>
        <table id="summaryTable" class="summary-table">
            <thead>
                <tr>
                    <th colspan="2">Name</th>
                    <th colspan="2">Assignment</th>
                    <th colspan="2">Last Contact</th>
                    <!-- print-only Notes header to align the Notes column in print; hidden on screen via inline style -->
                    <th rowspan="2" class="notes-col print-only" style="display:none">Summary</th>
                </tr>
                <tr>
                    <th>Last</th>
                    <th>First</th>
                    <th>Make Contact</th>
                    <th>Deacons</th>
                    <th>When</th>
                    <th>Who & How</th>
                    
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <script type="module">
        // Load reusable navigation bar
        document.addEventListener('DOMContentLoaded', async () => {
            const navContainer = document.getElementById('site-nav-container');
            if (navContainer) {
                const navResp = await fetch('site-nav.html');
                if (navResp.ok) {
                    navContainer.innerHTML = await navResp.text();
                    const script = document.createElement('script');
                    script.src = 'site-nav.js';
                    document.body.appendChild(script);
                }
            }
        });
        import { apiFetch } from './fetch-utils.js';

        async function fetchSummary() {
            const response = await apiFetch('api/reports/summary');
            const data = await response.json();
            const tableBody = document.getElementById('summaryTable').querySelector('tbody');

            data.summary.sort((a, b) => a.household.lastName.localeCompare(b.household.lastName));

            tableBody.innerHTML = data.summary.map((item, idx) => {
                const currentHouseholdId = item.household._id;
                const householdName = item.household?.members?.map(m => m.firstName).join(' & ');

                const phoneNumbers = getBestContactMethod(item.household);
                const deacons = item.assignedDeacons?.map(d => `${d.firstName} ${d.lastName}`).join(', ') || "(Assign)";
                const lastContactDate = item.lastContact?.contactDate ? new Date(item.lastContact.contactDate) : null;

                const contactedBy = getContactedBy(item.lastContact);
                let contactDateClass = getContactDateClass(lastContactDate);

                const rowClass = idx % 2 === 0 ? 'even' : 'odd';
                return `
                    <tbody class="summary-group">
                        <tr class="summary-row ${rowClass}">
                            <td class="summary-badge-col">
                                <a class="member-link" href="household.html?id=${currentHouseholdId}">${item.household.lastName}</a>
                                <span class="cell-badge">Last</span>
                            </td>
                            <td class="summary-badge-col">
                                <a class="member-link" href="household.html?id=${currentHouseholdId}">${householdName}</a>
                                <span class="cell-badge">First</span>
                            </td>
                            <td class="summary-badge-col">
                                <a href="record-contact.html?householdId=${currentHouseholdId}">${phoneNumbers}</a>
                                <span class="cell-badge">Make Contact</span>
                            </td>
                            <td class="summary-badge-col">
                                <a href="assign-deacons.html?householdId=${currentHouseholdId}">${deacons}</a>
                                <span class="cell-badge">Deacons</span>
                            </td>
                            <td class="last-contact-col ${contactDateClass}">
                                ${lastContactDate ? lastContactDate.toLocaleDateString() : '(needed)'}
                                <span class="cell-badge">When</span>
                            </td>
                            <td class="last-contact-col">
                                ${contactedBy}
                                <span class="cell-badge">Who & How</span>
                            </td>
                            <td class="last-contact-col notes-col">
                                ${item.summary}
                                <span class="cell-badge">Summary</span>
                            </td>
                        </tr>
                    </tbody>
                `;
            }).join('');
        }

        function getBestContactMethod(household) {
            let phoneNumbers = "";
            if (household?.members?.length) {
                phoneNumbers = household.members
                    .filter(m => m.phone)
                    .map(m => `${m.firstName?.charAt(0)}: ${m.phone}`)
                    .join('<br>');
            }
            if (household?.primaryPhone) {
                phoneNumbers += (phoneNumbers ? "<br>" : "") + `P: ${household.primaryPhone}`;
            }
            if (!phoneNumbers && household?.address?.street) {
                phoneNumbers = `${household.address.street}<br>${household.address.city}`;
            }
            return phoneNumbers || "(Contact)";
        }

        function getContactedBy(lastContact) {
            if (!lastContact) return "";
            let contactedBy = "";
            switch (lastContact.contactType) {
                case 'phone':
                    contactedBy = "Called";
                    break;
                case 'visit':
                    contactedBy = "Visited";
                    break;
                case 'voicemail':
                    contactedBy = "Left voicemail";
                    break;
                case 'church':
                    contactedBy = "Spoke at church";
                    break;
            }
            if (lastContact.contactedBy?.length) {
                if (contactedBy) contactedBy += " by ";
                contactedBy += lastContact.contactedBy.map(c => `${c.firstName} ${c.lastName}`).join(', ');
            }
            return contactedBy;
        };

        function getContactDateClass(lastContactDate) {
            let contactDateClass = '';
            if (lastContactDate) {
                const weeksAgo = (Date.now() - lastContactDate.getTime()) / (1000 * 60 * 60 * 24 * 7);
                if (weeksAgo > 6) {
                    contactDateClass = 'red';
                } else if (weeksAgo > 3) {
                    contactDateClass = 'yellow';
                }
            } else {
                contactDateClass = 'red'
            }
            return contactDateClass;
        }

        document.addEventListener('DOMContentLoaded', fetchSummary);
    </script>
    <script>
        // Inject a print-only colgroup just before printing and remove it after.
        // This avoids changing the on-screen layout while giving the print renderer
        // explicit column widths to align headers and body.
        (function() {
            const colgroupId = 'print-colgroup';
            const widths = ['10%','10%','11%','11%','7.5%','7.5%','43%'];

            function createColGroup() {
                if (document.getElementById(colgroupId)) return;
                const table = document.getElementById('summaryTable');
                if (!table) return;
                const cg = document.createElement('colgroup');
                cg.id = colgroupId;
                widths.forEach(w => {
                    const c = document.createElement('col');
                    c.style.width = w;
                    cg.appendChild(c);
                });
                // Insert as first child of the table so it affects layout
                table.insertBefore(cg, table.firstChild);
            }

            function removeColGroup() {
                const cg = document.getElementById(colgroupId);
                if (cg) cg.remove();
            }

            // Modern browsers: matchMedia for print
            if (window.matchMedia) {
                const m = window.matchMedia('print');
                try { m.addListener(e => { if (e.matches) createColGroup(); else removeColGroup(); }); } catch (e) {}
            }

            // fallback: beforeprint/afterprint events
            window.addEventListener('beforeprint', createColGroup);
            window.addEventListener('afterprint', removeColGroup);

            // Safety: remove if page is navigated or on load complete
            window.addEventListener('pageshow', removeColGroup);
            window.addEventListener('DOMContentLoaded', removeColGroup);
        })();
    </script>
</body>
</html>
