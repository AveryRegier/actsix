<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record Contact - Deacon Care System</title>
    <link rel="stylesheet" href="site.css">
</head>
<body>
    <div class="container">
        <!-- Reusable navigation bar -->
        <div id="site-nav-container"></div>
        <div class="header">
            <h1 style="display:flex;align-items:center;justify-content:center;font-size:1.3em;font-weight:400;gap:0.5em;">
                <span style="font-size:1.1em;">üìù</span>
                Record Contact
            </h1>
        </div>
        <div class="content">
            <form id="contact-form">
                <div class="form-group">
                    <label for="contact-date">Contact Date</label>
                    <!-- dynamically preset to today's date -->
                        <input type="date" id="contact-date" name="contactDate" required>
                </div>
                <div class="form-group">
                    <label for="contact-type">Contact Type</label>
                    <select id="contact-type" name="contactType" required>
                        <option value="phone">Phone</option>
                        <option value="visit">Visit</option>
                        <option value="text">Text</option>
                        <option value="voicemail">Voice mail</option>
                        <option value="church">At Church</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="summary">Summary</label>
                    <textarea id="summary" name="summary" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>Members Contacted</label>
                    <div class="member-list" id="membersSection">
                        <!-- Members will be populated by JavaScript -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Contacted by</label>
                    <div class="member-list" id="deaconsSection">
                        <!-- Deacons will be populated by JavaScript -->
                    </div>
                </div>
                <div class="form-group">
                    <button type="button" class="btn" id="addParticipantBtn" onclick="showParticipantModal()">Add Participant</button>
                </div>

                <!-- Participant Modal -->
                <div id="participantModal" class="modal" style="display:none;">
                    <div class="modal-content">
                        <span class="close" onclick="closeParticipantModal()">&times;</span>
                        <h2>Select Participant</h2>
                        <div id="participantList">
                            <!-- Participants will be populated by JavaScript -->
                        </div>
                        <button type="button" class="btn" onclick="addSelectedParticipant()">Add Selected</button>
                    </div>
                </div>

                <button type="submit" class="btn">Submit Contact</button>
            </form>
        </div>
    </div>
    <script>
        // Load reusable navigation bar
        document.addEventListener('DOMContentLoaded', async () => {
            const navContainer = document.getElementById('site-nav-container');
            if (navContainer) {
                const navResp = await fetch('site-nav.html');
                if (navResp.ok) {
                    navContainer.innerHTML = await navResp.text();
                    const script = document.createElement('script');
                    script.src = 'site-nav.js';
                    document.body.appendChild(script);
                }
            }
        });
        document.addEventListener('DOMContentLoaded', async () => {
            // get household id from request parameter
            const urlParams = new URLSearchParams(window.location.search);
            const currentHouseholdId = urlParams.get('householdId');

                // Dynamically preset contact date to today
                const contactDateInput = document.getElementById('contact-date');
                if (contactDateInput) {
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    contactDateInput.value = `${yyyy}-${mm}-${dd}`;
                }
            // Use the new API to fetch members
            const membersResponse = await fetch(`api/households/${currentHouseholdId}/members`);
            console.log('Members Response Status:', membersResponse.status);
            const membersData = await membersResponse.json();
            console.log('Members Response:', membersData);
            const members = membersData.members;

            // Populate members section
            const membersSection = document.getElementById('membersSection');
            membersSection.innerHTML = members.filter(m=>!m.tags.includes('deceased')).map(member => {
                const isSelected = member.tags && member.tags.some(tag => ['cancer', 'shut-in', 'long-term-needs'].includes(tag));
                const displayName = member.relationship === 'head' ? `${member.firstName} ${member.lastName}` : `${member.firstName} ${member.lastName} (${member.relationship})`;
                return `
                    <div class="member-item">
                        <input type="checkbox" id="member-${member._id}" name="memberId" value="${member._id}" ${isSelected ? 'checked' : ''}>
                        <label for="member-${member._id}">${displayName}</label>
                        &nbsp;<p>${member.phone}</p>
                    </div>
                `;
            }).join('');

            // Fetch assigned deacons
            const assignmentsResponse = await fetch(`api/households/${currentHouseholdId}/assignments`);
            const assignmentsData = await assignmentsResponse.json();
            const assignedDeacons = assignmentsData.assignments;

            // Populate assigned deacons section
            const deaconsSection = document.getElementById('deaconsSection');
            deaconsSection.innerHTML = assignedDeacons.map(assignment => `
                <div class="member-item">
                    <input type="checkbox" id="deacon-${assignment.deacon._id}" name="deaconId" value="${assignment.deacon._id}" checked>
                    <label for="deacon-${assignment.deacon._id}">${assignment.deacon.firstName} ${assignment.deacon.lastName}</label>
                </div>
            `).join('');

            // Fetch household details
            const householdResponse = await fetch(`api/households/${currentHouseholdId}`);
            const household = await householdResponse.json();

            // Display household phone numbers and address
            const contactTypeSection = document.getElementById('contact-type').parentElement;
            const householdInfo = document.createElement('div');
            householdInfo.innerHTML = (household.primaryPhone ?`
                <div class="form-group">
                    <label>Household Phone</label>
                    <p>${household.primaryPhone}</p>
                </div>` : '') + 
                (household.address ? `
                <div class="form-group">
                    <label>Address</label>
                    <p>${household.address.street}, ${household.address.city}, ${household.address.state} ${household.address.zipCode}</p>
                </div>` : '');
            contactTypeSection.insertAdjacentElement('afterend', householdInfo);
        });

        function showParticipantModal() {
            document.getElementById('participantModal').style.display = 'block';
            loadParticipants();
        }

        function closeParticipantModal() {
            document.getElementById('participantModal').style.display = 'none';
        }

        async function loadParticipants() {
            const response = await fetch('api/participants');
            const participants = await response.json();
            const participantList = document.getElementById('participantList');
            participantList.innerHTML = participants.participants.map(p => `
                <div class="member-item">
                    <input type="checkbox" id="participant-${p._id}" name="participantId" value="${p._id}">
                    <label for="participant-${p._id}">${p.firstName} ${p.lastName} (${p.role})</label>
                </div>
            `).join('');
        }

        function addSelectedParticipant() {
            const selectedParticipants = Array.from(document.querySelectorAll('#participantList input:checked'));
            const deaconsSection = document.getElementById('deaconsSection');
            const existingIds = Array.from(deaconsSection.querySelectorAll('input')).map(input => input.value);

            selectedParticipants.forEach(sp => {
                if (!existingIds.includes(sp.value)) {
                    const participantName = document.querySelector(`label[for="${sp.id}"]`).textContent;
                    deaconsSection.innerHTML += `
                        <div class="member-item">
                            <input type="checkbox" id="${sp.id}" name="deaconId" value="${sp.value}" checked>
                            <label for="${sp.id}">${participantName}</label>
                        </div>
                    `;
                }
            });
            closeParticipantModal();
        }

        document.getElementById('contact-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            const formData = new FormData(event.target);

            // Get all members and selected members
            const allMembers = Array.from(document.querySelectorAll('#membersSection input'));
            let selectedMembers = Array.from(document.querySelectorAll('#membersSection input:checked'));

            // Automatically select the single member if only one exists
            if (selectedMembers.length === 0 && allMembers.length === 1) {
                allMembers[0].checked = true;
            }
            selectedMembers = Array.from(document.querySelectorAll('#membersSection input:checked'));
            
            // Require at least one member to be selected
            if (selectedMembers.length === 0) {
                alert('Please select at least one member.');
                return;
            }

            // Format the body to match the requirements of the /api/contacts REST API
            const contactData = {
                memberId: Array.from(document.querySelectorAll('#membersSection input:checked')).map(input => input.value),
                deaconId: Array.from(document.querySelectorAll('#deaconsSection input:checked')).map(input => input.value),
                contactType: formData.get('contactType'),
                summary: formData.get('summary'),
                contactDate: new Date(formData.get('contactDate')).toISOString(),
                followUpRequired: false, // Default value
            };

            try {
                const response = await fetch('api/contacts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(contactData),
                });

                if (response.ok) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const currentHouseholdId = urlParams.get('householdId');
                    window.location.href = `/household.html?id=${currentHouseholdId}`;
                } else {
                    console.error('Failed to submit contact:', response.statusText);
                    alert('Failed to submit contact. Please try again.');
                }
            } catch (error) {
                console.error('Error submitting contact:', error);
                alert('An error occurred while submitting the contact. Please try again.');
            }
        });
    </script>
    <script src="redirect-handler.js"></script>
</body>
</html>
