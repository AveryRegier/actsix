<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record Contact - Deacon Care System</title>
    <script>
        // Polyfill Array.from for older browsers (must load first)
        if (!Array.from) {
            Array.from = function(arrayLike) {
                return Array.prototype.slice.call(arrayLike);
            };
        }
    </script>
    <link rel="stylesheet" href="site.css">
</head>
<body>
    <div class="container">
        <!-- Reusable navigation bar -->
        <div id="site-nav-container"></div>
        <div class="header">
            <h1 style="display:flex;align-items:center;justify-content:center;font-size:1.3em;font-weight:400;gap:0.5em;">
                <span style="font-size:1.1em;">üìù</span>
                Record Contact
            </h1>
        </div>
        <div class="content">
            <form id="contact-form" action="/form/record-contact" method="POST">
                <input type="hidden" id="householdId" name="householdId" value="">
                <div class="form-group">
                    <label for="contact-date">Contact Date</label>
                    <!-- dynamically preset to today's date -->
                        <input type="date" id="contact-date" name="contactDate" required>
                </div>
                <div class="form-group">
                    <label for="contact-type">Contact Type</label>
                    <select id="contact-type" name="contactType" required>
                        <option value="phone">Phone</option>
                        <option value="visit">Visit</option>
                        <option value="text">Text</option>
                        <option value="voicemail">Voice mail</option>
                        <option value="church">At Church</option>
                        <option value="note">Note</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="summary">Summary</label>
                    <textarea id="summary" name="summary" rows="4" required></textarea>
                </div>
                <div class="form-group">
                    <label>Members Contacted</label>
                    <div class="member-list" id="membersSection">
                        <!-- Members will be populated by JavaScript -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Contacted by</label>
                    <div class="member-list" id="deaconsSection">
                        <!-- Deacons will be populated by JavaScript -->
                    </div>
                </div>
                <div class="form-group">
                    <button type="button" class="btn" id="addParticipantBtn">Add Participant</button>
                </div>

                <!-- Participant Modal -->
                <div id="participantModal" class="modal" style="display:none;">
                    <div class="modal-content">
                        <span class="close" id="closeParticipantModalBtn">&times;</span>
                        <h2>Select Participant</h2>
                        <div id="participantList">
                            <!-- Participants will be populated by JavaScript -->
                        </div>
                        <button type="button" class="btn" id="addSelectedParticipantBtn">Add Selected</button>
                    </div>
                </div>

                <button type="submit" class="btn">Submit Contact</button>
            </form>
        </div>
    </div>
    <script type="module">
        import { formatAddressForDisplay, formatAddressForMaps } from './address-utils.js';
        
        // Load reusable navigation bar and initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Load navigation first
            const navContainer = document.getElementById('site-nav-container');
            if (navContainer) {
                try {
                    const navResp = await fetch('site-nav.html');
                    if (navResp.ok) {
                        navContainer.innerHTML = await navResp.text();
                        const script = document.createElement('script');
                        script.src = 'site-nav.js';
                        document.body.appendChild(script);
                    }
                } catch (error) {
                    console.error('Error loading navigation:', error);
                }
            }

            // get household id from request parameter
            const urlParams = new URLSearchParams(window.location.search);
            const currentHouseholdId = urlParams.get('householdId');
            
            // Set hidden field value
            const householdIdInput = document.getElementById('householdId');
            if (householdIdInput && currentHouseholdId) {
                householdIdInput.value = currentHouseholdId;
            }

            // Dynamically preset contact date to today
            const contactDateInput = document.getElementById('contact-date');
            if (contactDateInput) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                contactDateInput.value = yyyy + '-' + mm + '-' + dd;
            }
            // Use the new API to fetch members
            try {
                const membersResponse = await fetch('api/households/' + currentHouseholdId + '/members');
                console.log('Members Response Status:', membersResponse.status);
                const membersData = await membersResponse.json();
                console.log('Members Response:', membersData);
                const members = membersData.members;

                // Populate members section
                const membersSection = document.getElementById('membersSection');
                var memberItems = [];
                for (var i = 0; i < members.length; i++) {
                    var member = members[i];
                    if (member.tags && member.tags.includes('deceased')) continue;
                    
                    var isSelected = member.tags && member.tags.some(function(tag) { 
                        return ['cancer', 'shut-in', 'long-term-needs'].includes(tag); 
                    });
                    var displayName = member.relationship === 'head' 
                        ? member.firstName + ' ' + member.lastName 
                        : member.firstName + ' ' + member.lastName + ' (' + member.relationship + ')';
                    
                    memberItems.push(
                        '<div class="member-item">' +
                        '<input type="checkbox" id="member-' + member._id + '" name="memberId" value="' + member._id + '" ' + (isSelected ? 'checked' : '') + '>' +
                        '<label for="member-' + member._id + '">' + displayName + '</label>' +
                        '&nbsp;<p>' + member.phone + '</p>' +
                        '</div>'
                    );
                }
                membersSection.innerHTML = memberItems.join('');

                // Fetch assigned deacons
                const assignmentsResponse = await fetch('api/households/' + currentHouseholdId + '/assignments');
                const assignmentsData = await assignmentsResponse.json();
                const assignedDeacons = assignmentsData.assignments;

                // Populate assigned deacons section
                const deaconsSection = document.getElementById('deaconsSection');
                var deaconItems = [];
                for (var j = 0; j < assignedDeacons.length; j++) {
                    var assignment = assignedDeacons[j];
                    deaconItems.push(
                        '<div class="member-item">' +
                        '<input type="checkbox" id="deacon-' + assignment.deacon._id + '" name="deaconId" value="' + assignment.deacon._id + '" checked>' +
                        '<label for="deacon-' + assignment.deacon._id + '">' + assignment.deacon.firstName + ' ' + assignment.deacon.lastName + '</label>' +
                        '</div>'
                    );
                }
                deaconsSection.innerHTML = deaconItems.join('');

                // Fetch household details
                const householdResponse = await fetch('api/households/' + currentHouseholdId);
                const household = await householdResponse.json();

                // Display household phone numbers and address
                const contactTypeSection = document.getElementById('contact-type').parentElement;
                const householdInfo = document.createElement('div');
                var infoHtml = '';
                if (household.primaryPhone) {
                    infoHtml += '<div class="form-group"><label>Household Phone</label><p>' + household.primaryPhone + '</p></div>';
                }
                if (household.address) {
                    const displayAddress = formatAddressForDisplay(household.address).replace(/<br>/g, ', ');
                    const mapsUrl = formatAddressForMaps(household.address);
                    infoHtml += '<div class="form-group"><label>Address</label><p><a href="' + mapsUrl + '" target="_blank" rel="noopener noreferrer" style="color: #0066cc; text-decoration: none;">' + displayAddress + '</a></p></div>';
                }
                
                // Add temporary location info placeholder if available
                let tempMember = null;
                for (var tm = 0; tm < members.length; tm++) {
                    var m = members[tm];
                    if (m.temporaryAddress && m.temporaryAddress.isActive && m.temporaryAddress.locationId) {
                        tempMember = m;
                        break;
                    }
                }
                if (tempMember) {
                    infoHtml += '<div class="temp-location-info-container"></div>';
                }
                
                householdInfo.innerHTML = infoHtml;
                contactTypeSection.insertAdjacentElement('afterend', householdInfo);
                
                // Fetch and display temporary location if available
                if (tempMember) {
                    const { apiFetch } = await import('./fetch-utils.js');
                    apiFetch('api/common-locations/' + tempMember.temporaryAddress.locationId)
                        .then(res => res.json())
                        .then(data => {
                            const location = data.location;
                            if (location && location.address) {
                                const mapsUrl = formatAddressForMaps(location.address);
                                const displayAddress = formatAddressForDisplay(location.address, false);
                                const roomInfo = tempMember.temporaryAddress.roomNumber ? ' ‚Ä¢ Room/Unit: ' + tempMember.temporaryAddress.roomNumber : '';
                                const container = document.querySelector('.temp-location-info-container');
                                if (container) {
                                    let html = '<div class="form-group"><div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 10px;">' +
                                        '<strong style="color: #856404;">Temporary Location:</strong>' +
                                        '<div style="margin-top: 5px;">' +
                                        '<span style="color: #333;">' + location.name + roomInfo + '</span>' +
                                        '</div>' +
                                        '<div style="margin-top: 3px; font-size: 0.9em;">' +
                                        '<a href="' + mapsUrl + '" target="_blank" rel="noopener noreferrer" style="color: #0066cc; text-decoration: none;">' + displayAddress + '</a>' +
                                        '</div>';
                                    if (tempMember.temporaryAddress.startDate) {
                                        html += '<div style="margin-top: 3px; font-size: 0.85em; color: #666;">Since: ' + new Date(tempMember.temporaryAddress.startDate).toLocaleDateString() + '</div>';
                                    }
                                    if (tempMember.temporaryAddress.notes) {
                                        html += '<div style="margin-top: 5px; font-size: 0.9em; font-style: italic; color: #555;">' + tempMember.temporaryAddress.notes + '</div>';
                                    }
                                    html += '</div></div>';
                                    container.innerHTML = html;
                                }
                            }
                        })
                        .catch(err => console.error('Error fetching location:', err));
                }
            } catch (error) {
                console.error('Error loading page data:', error);
                alert('Error loading page data. Please try again.');
            }
        });

        function showParticipantModal() {
            document.getElementById('participantModal').style.display = 'block';
            loadParticipants();
        }

        function closeParticipantModal() {
            document.getElementById('participantModal').style.display = 'none';
        }

        async function loadParticipants() {
            try {
                const response = await fetch('api/participants');
                const participants = await response.json();
                const participantList = document.getElementById('participantList');
                var participantItems = [];
                for (var i = 0; i < participants.participants.length; i++) {
                    var p = participants.participants[i];
                    participantItems.push(
                        '<div class="member-item">' +
                        '<input type="checkbox" id="participant-' + p._id + '" name="participantId" value="' + p._id + '">' +
                        '<label for="participant-' + p._id + '">' + p.firstName + ' ' + p.lastName + ' (' + p.role + ')</label>' +
                        '</div>'
                    );
                }
                participantList.innerHTML = participantItems.join('');
            } catch (error) {
                console.error('Error loading participants:', error);
            }
        }

        function addSelectedParticipant() {
            var selectedParticipants = Array.from(document.querySelectorAll('#participantList input:checked'));
            var deaconsSection = document.getElementById('deaconsSection');
            var existingInputs = Array.from(deaconsSection.querySelectorAll('input'));
            var existingIds = [];
            for (var i = 0; i < existingInputs.length; i++) {
                existingIds.push(existingInputs[i].value);
            }

            for (var j = 0; j < selectedParticipants.length; j++) {
                var sp = selectedParticipants[j];
                var isExisting = false;
                for (var k = 0; k < existingIds.length; k++) {
                    if (existingIds[k] === sp.value) {
                        isExisting = true;
                        break;
                    }
                }
                if (!isExisting) {
                    var participantName = document.querySelector('label[for="' + sp.id + '"]').textContent;
                    deaconsSection.innerHTML += 
                        '<div class="member-item">' +
                        '<input type="checkbox" id="' + sp.id + '" name="deaconId" value="' + sp.value + '" checked>' +
                        '<label for="' + sp.id + '">' + participantName + '</label>' +
                        '</div>';
                }
            }
            closeParticipantModal();
        }

        var addParticipantBtn = document.getElementById('addParticipantBtn');
        if (addParticipantBtn) {
            addParticipantBtn.addEventListener('click', showParticipantModal);
        }

        var closeParticipantModalBtn = document.getElementById('closeParticipantModalBtn');
        if (closeParticipantModalBtn) {
            closeParticipantModalBtn.addEventListener('click', closeParticipantModal);
        }

        var addSelectedParticipantBtn = document.getElementById('addSelectedParticipantBtn');
        if (addSelectedParticipantBtn) {
            addSelectedParticipantBtn.addEventListener('click', addSelectedParticipant);
        }

        // Form validation before submit (no async/fetch needed)
        document.getElementById('contact-form').addEventListener('submit', function(event) {
            // Get all members and selected members
            var allMembers = Array.from(document.querySelectorAll('#membersSection input'));
            var selectedMembers = Array.from(document.querySelectorAll('#membersSection input:checked'));

            // Automatically select the single member if only one exists
            if (selectedMembers.length === 0 && allMembers.length === 1) {
                allMembers[0].checked = true;
                selectedMembers = [allMembers[0]];
            }
            
            // Require at least one member to be selected
            if (selectedMembers.length === 0) {
                event.preventDefault();
                alert('Please select at least one member.');
                return false;
            }
            
            // Form will submit normally to /form/record-contact
            return true;
        });
    </script>
    <script src="redirect-handler.js"></script>
</body>
</html>
