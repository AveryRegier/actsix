
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Deacon Quick Contact - Deacon Care System</title>
	<link rel="stylesheet" href="site.css">
</head>
<body>
	<div class="container">
		<!-- Reusable navigation bar -->
		<div id="site-nav-container"></div>
		<div class="header">
			<h1 style="display:flex;align-items:center;justify-content:center;font-size:1.5em;font-weight:400;gap:0.5em;">
				<span style="font-size:1.1em;">ðŸ“ž</span>
				Deacon Quick Contact
			</h1>
		</div>
		<div class="section">
			<!-- Intentionally no section title to match contact-summary layout -->
			<table id="quickContactsTable" class="summary-table">
				<thead>
					<tr>
						<th>Name</th>
						<th>Make Contact</th>
						<th>Action</th>
					</tr>
					<tr>
						<th>How & When</th>
						<th colspan="2">Summary</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>

	<script type="module">
	// Polyfill Array.from for older browsers
	if (!Array.from) {
		Array.from = function(arrayLike) {
			return Array.prototype.slice.call(arrayLike);
		};
	}

	import { getContactedBy } from './contact-utils.js';
	import { formatAddressForDisplay, formatAddressForMaps } from './address-utils.js';
	import { apiFetch } from './fetch-utils.js';

	// Consolidated DOMContentLoaded listener
	document.addEventListener('DOMContentLoaded', function() {
		// Load reusable navigation bar
		var navContainer = document.getElementById('site-nav-container');
		if (navContainer) {
			fetch('site-nav.html')
				.then(function(navResp) {
					if (navResp.ok) {
						return navResp.text();
					}
					throw new Error('Failed to load navigation');
				})
				.then(function(navHtml) {
					navContainer.innerHTML = navHtml;
					var script = document.createElement('script');
					script.src = 'site-nav.js';
					document.body.appendChild(script);
				})
				.catch(function(error) {
					console.error('Error loading navigation:', error);
				});
		}
		// Get deacon memberId from actsix cookie
		// function getCookie(name) {
		// 	const value = `; ${document.cookie}`;
		// 	const parts = value.split(`; ${name}=`);
		// 	if (parts.length === 2) return parts.pop().split(';').shift();
		// }
		// let deaconMemberId = null;
		// const actsixCookie = getCookie('actsix');
		// if (actsixCookie) {
		// 	const decodedCookie = decodeURIComponent(actsixCookie);
		// 	deaconMemberId = decodedCookie.split('|')[0];
		// }
		// if (!deaconMemberId) {
		// 	if (window.currentMemberId) {
		// 		deaconMemberId = window.currentMemberId;
		// 	} else {
		// 		try {
		// 			const meRes = await fetch('/api/me');
		// 			if (meRes.ok) {
		// 				const meData = await meRes.json();
		// 				deaconMemberId = meData._id;
		// 			}
		// 		} catch (err) {
		// 			const urlParams = new URLSearchParams(window.location.search);
		// 			deaconMemberId = urlParams.get('deaconMemberId');
		// 		}
		// 	}
		// }
		// if (!deaconMemberId) {
		// 	alert('Unable to determine logged-in member (deacon) ID.');
		// 	return;
		// }

		// Fetch precomputed quick contacts in one call
		var requestDeaconMemberId = new URLSearchParams(window.location.search).get('deaconMemberId');
		var deaconMemberId = requestDeaconMemberId || localStorage.getItem('memberId') || 'unknown';
		fetch('/api/deacons/' + deaconMemberId + '/quickContacts')
			.then(function(qcRes) {
				return qcRes.json();
			})
			.then(function(qcData) {
				var quickContacts = qcData.quickContacts || [];

				// Render two-line rows using returned data. Use CSS classes defined in site.css.
				var tbody = document.querySelector('#quickContactsTable tbody');

				// Build clickable contact HTML for phone/address on the deacon quick page only.
				function buildClickableContact(item) {
					var members = item.members || [];
					var parts = [];
					// member phones first
					for (var i = 0; i < members.length; i++) {
						var m = members[i];
						if (m.phone) {
							var initial = m.firstName ? m.firstName.charAt(0) : '';
							parts.push({label: initial + ': ', value: m.phone});
						}
					}
					// household primary phone
					if (item.primaryPhone) parts.push({label: 'P: ', value: item.primaryPhone});
					if (parts.length) {
						var html = [];
						for (var j = 0; j < parts.length; j++) {
							var p = parts[j];
							html.push('<a href="tel:' + encodeURIComponent(p.value) + '">' + p.label + p.value + '</a>');
						}
						return html.join('<br>');
					}
					// fallback to address link
					if (item.address && item.address.street) {
						var url = formatAddressForMaps(item.address);
						var displayAddress = formatAddressForDisplay(item.address);
						return '<a href="' + url + '" target="_blank" rel="noopener noreferrer">' + displayAddress + '</a>';
					}
					return '(Contact)';
				}

				var rowsHtml = [];
				var tempLocationFetches = [];  // Track location fetches
				for (var idx = 0; idx < quickContacts.length; idx++) {
					var item = quickContacts[idx];
					var householdLink = 'household.html?id=' + item.householdId;
					var contactLink = 'record-contact.html?householdId=' + item.householdId;
					var lastDate = item.lastContact && item.lastContact.contactDate ? new Date(item.lastContact.contactDate).toLocaleDateString() : '(needed)';

					// compute clickable best contact locally (tel: links and maps)
					var bestContactHtml = buildClickableContact(item);

					// display label: prefer the specific member(s) from lastContact.memberId
					var contactTargetName = '';
					if (item.lastContact && item.lastContact.memberId && item.members && item.members.length) {
						var targets = [];
						for (var mi = 0; mi < item.members.length; mi++) {
							var mem = item.members[mi];
							for (var mj = 0; mj < item.lastContact.memberId.length; mj++) {
								if (item.lastContact.memberId[mj] === mem._id) {
									targets.push(mem);
									break;
								}
							}
						}
						if (targets.length === 1) {
							contactTargetName = targets[0].firstName + ' ' + targets[0].lastName;
						} else if (targets.length > 1) {
							var targetNames = [];
							for (var ti = 0; ti < targets.length; ti++) {
								targetNames.push(targets[ti].firstName + ' ' + targets[ti].lastName);
							}
							contactTargetName = targetNames.join(' & ');
						}
					}
					var displayLabel = contactTargetName || item.displayName;

					var deacons = '(Assign)';
					if (item.assignedDeacons && item.assignedDeacons.length) {
						var deaconNames = [];
						for (var di = 0; di < item.assignedDeacons.length; di++) {
							var d = item.assignedDeacons[di];
							deaconNames.push(d.firstName + ' ' + d.lastName);
						}
						deacons = deaconNames.join(', ');
					}

					var contactedBy = getContactedBy(item.lastContact);
					var summary = (item.lastContact && item.lastContact.summary) || item.summary || '';

					// Store temporary location info for later fetching (after DOM is ready)
					var tempMember = null;
					if (item.members && item.members.length > 0) {
						for (var mi = 0; mi < item.members.length; mi++) {
							var mem = item.members[mi];
							if (mem.temporaryAddress && mem.temporaryAddress.isActive && mem.temporaryAddress.locationId) {
								tempMember = mem;
								break;  // Only process first member with temp location
							}
						}
					}

					var rowClass = idx % 2 === 0 ? 'even' : 'odd';

					rowsHtml.push(
						'<tr class="summary-row ' + rowClass + '" data-household-id="' + item.householdId + '">' +
						'<td class="summary-badge-col name-col">' +
						'<a class="member-link" href="' + householdLink + '">' + displayLabel + '</a>' +
						'</td>' +
						'<td class="summary-badge-col contact-col">' +
						'<div class="contact-cell">' + bestContactHtml + '</div>' +
						'</td>' +
						'<td class="summary-badge-col action-col">' +
						'<a href="' + contactLink + '" class="btn record-btn" role="button" aria-label="Record contact for ' + displayLabel + '" title="Record contact for ' + displayLabel + '">Record</a>' +
						'</td>' +
						'</tr>' +
						'<tr class="summary-row ' + rowClass + ' second-row" data-household-id="' + item.householdId + '">' +
						'<td class="last-contact-col howwhen-col">' + (contactedBy ? contactedBy + ' on ' + lastDate : lastDate) + '</td>' +
						'<td class="notes-col" colspan="2">' + summary + '<div class="temp-location-info" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd;"></div></td>' +
						'</tr>'
					);

					// Queue location fetch if member has temp address
					if (tempMember) {
						tempLocationFetches.push({
							householdId: item.householdId,
							locationId: tempMember.temporaryAddress.locationId,
							roomNumber: tempMember.temporaryAddress.roomNumber,
							startDate: tempMember.temporaryAddress.startDate,
							notes: tempMember.temporaryAddress.notes
						});
					}
				}
				tbody.innerHTML = rowsHtml.join('');

				// Now fetch all location details after DOM is rendered
				tempLocationFetches.forEach(function(fetchInfo) {
					apiFetch('api/common-locations/' + fetchInfo.locationId)
						.then(function(res) { 
							return res.json(); 
						})
						.then(function(data) {
							var location = data.location;
							if (location && location.address) {
								var mapsUrl = formatAddressForMaps(location.address);
								var displayAddress = formatAddressForDisplay(location.address, false);
								var roomInfo = fetchInfo.roomNumber ? ' â€¢ Room/Unit: ' + fetchInfo.roomNumber : '';
								var selector = 'tr[data-household-id="' + fetchInfo.householdId + '"] .temp-location-info';
								var locElement = document.querySelector(selector);
								if (locElement) {
									var html = '<div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 10px; margin-top: 10px;">' +
										'<strong style="color: #856404;">Temporary Location:</strong>' +
										'<div style="margin-top: 5px;">' +
										'<span style="color: #333;">' + location.name + roomInfo + '</span>' +
										'</div>' +
										'<div style="margin-top: 3px; font-size: 0.9em;">' +
										'<a href="' + mapsUrl + '" target="_blank" rel="noopener noreferrer" style="color: #0066cc; text-decoration: none;">' + displayAddress + '</a>' +
										'</div>';
									if (fetchInfo.startDate) {
										html += '<div style="margin-top: 3px; font-size: 0.85em; color: #666;">Since: ' + new Date(fetchInfo.startDate).toLocaleDateString() + '</div>';
									}
									if (fetchInfo.notes) {
										html += '<div style="margin-top: 5px; font-size: 0.9em; font-style: italic; color: #555;">' + fetchInfo.notes + '</div>';
									}
									html += '</div>';
									locElement.innerHTML = html;
								}
							}
						})
						.catch(function(err) { console.error('Error fetching location:', err); });
				});
			})
			.catch(function(error) {
				console.error('Error loading quick contacts:', error);
				alert('Failed to load quick contacts. Please try again.');
			});
	});
	</script>
</body>
</html>
