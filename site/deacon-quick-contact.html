
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Deacon Quick Contact - Deacon Care System</title>
	<link rel="stylesheet" href="site.css">
</head>
<body>
	<div class="container">
		<!-- Reusable navigation bar -->
		<div id="site-nav-container"></div>
		<div class="header">
			<h1 style="display:flex;align-items:center;justify-content:center;font-size:1.5em;font-weight:400;gap:0.5em;">
				<span style="font-size:1.1em;">ðŸ“ž</span>
				Deacon Quick Contact
			</h1>
		</div>
		<div class="section">
			<!-- Intentionally no section title to match contact-summary layout -->
			<table id="quickContactsTable" class="summary-table">
				<thead>
					<tr>
						<th>Name</th>
						<th>Make Contact</th>
						<th>Action</th>
					</tr>
					<tr>
						<th>How & When</th>
						<th colspan="2">Summary</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>

	<script type="module">
	import { getContactedBy } from './contact-utils.js';
	// Load reusable navigation bar
	document.addEventListener('DOMContentLoaded', async () => {
		const navContainer = document.getElementById('site-nav-container');
		if (navContainer) {
			const navResp = await fetch('site-nav.html');
			if (navResp.ok) {
				navContainer.innerHTML = await navResp.text();
				const script = document.createElement('script');
				script.src = 'site-nav.js';
				document.body.appendChild(script);
			}
		}
	});

	document.addEventListener('DOMContentLoaded', async () => {
		// Get deacon memberId from actsix cookie
		// function getCookie(name) {
		// 	const value = `; ${document.cookie}`;
		// 	const parts = value.split(`; ${name}=`);
		// 	if (parts.length === 2) return parts.pop().split(';').shift();
		// }
		// let deaconMemberId = null;
		// const actsixCookie = getCookie('actsix');
		// if (actsixCookie) {
		// 	const decodedCookie = decodeURIComponent(actsixCookie);
		// 	deaconMemberId = decodedCookie.split('|')[0];
		// }
		// if (!deaconMemberId) {
		// 	if (window.currentMemberId) {
		// 		deaconMemberId = window.currentMemberId;
		// 	} else {
		// 		try {
		// 			const meRes = await fetch('/api/me');
		// 			if (meRes.ok) {
		// 				const meData = await meRes.json();
		// 				deaconMemberId = meData._id;
		// 			}
		// 		} catch (err) {
		// 			const urlParams = new URLSearchParams(window.location.search);
		// 			deaconMemberId = urlParams.get('deaconMemberId');
		// 		}
		// 	}
		// }
		// if (!deaconMemberId) {
		// 	alert('Unable to determine logged-in member (deacon) ID.');
		// 	return;
		// }

		// Fetch precomputed quick contacts in one call
		const requestDeaconMemberId = new URLSearchParams(window.location.search).get('deaconMemberId');
		const deaconMemberId = requestDeaconMemberId || localStorage.getItem('memberId') || 'unknown';
		const qcRes = await fetch(`/api/deacons/${deaconMemberId}/quickContacts`);
		const qcData = await qcRes.json();
		const quickContacts = qcData.quickContacts || [];

		// Render two-line rows using returned data. Use CSS classes defined in site.css.
		const tbody = document.querySelector('#quickContactsTable tbody');

		// Build clickable contact HTML for phone/address on the deacon quick page only.
		function buildClickableContact(item) {
			const members = item.members || [];
			const parts = [];
			// member phones first
			members.forEach(m => {
				if (m.phone) parts.push({label: `${m.firstName?.charAt(0)}: `, value: m.phone});
			});
			// household primary phone
			if (item.primaryPhone) parts.push({label: 'P: ', value: item.primaryPhone});
			if (parts.length) {
				return parts.map(p => `<a href="tel:${encodeURIComponent(p.value)}">${p.label}${p.value}</a>`).join('<br>');
			}
			// fallback to address link
			if (item.address && item.address.street) {
				const q = encodeURIComponent([item.address.street, item.address.city, item.address.state, item.address.postalCode].filter(Boolean).join(', '));
				const url = `https://www.google.com/maps/search/?api=1&query=${q}`;
				return `<a href="${url}" target="_blank" rel="noopener noreferrer">${item.address.street}<br>${item.address.city || ''}</a>`;
			}
			return '(Contact)';
		}
		tbody.innerHTML = quickContacts.map((item, idx) => {
			const householdLink = `household.html?id=${item.householdId}`;
			const contactLink = `record-contact.html?householdId=${item.householdId}`;
			const lastDate = item.lastContact?.contactDate ? new Date(item.lastContact.contactDate).toLocaleDateString() : '(needed)';

			// compute clickable best contact locally (tel: links and maps)
			const bestContactHtml = buildClickableContact(item);

			// display label: prefer the specific member(s) from lastContact.memberId
			let contactTargetName = '';
			if (item.lastContact?.memberId && item.members?.length) {
				const targets = item.members.filter(m => item.lastContact.memberId.includes(m._id));
				if (targets.length === 1) contactTargetName = `${targets[0].firstName} ${targets[0].lastName}`;
				else if (targets.length > 1) contactTargetName = targets.map(t => `${t.firstName} ${t.lastName}`).join(' & ');
			}
			const displayLabel = contactTargetName || item.displayName;

			const deacons = item.assignedDeacons?.map(d => `${d.firstName} ${d.lastName}`).join(', ') || '(Assign)';

			const contactedBy = getContactedBy(item.lastContact);
			const summary = item.lastContact?.summary || item.summary || '';

			const rowClass = idx % 2 === 0 ? 'even' : 'odd';

			return `
				<tbody class="summary-group">
					<tr class="summary-row ${rowClass}">
						<td class="summary-badge-col name-col">
							<a class="member-link" href="${householdLink}">${displayLabel}</a>
						</td>
						<td class="summary-badge-col contact-col">
							<div class="contact-cell">${bestContactHtml}</div>
						</td>
						<td class="summary-badge-col action-col">
							<a href="${contactLink}" class="btn record-btn" role="button" aria-label="Record contact for ${displayLabel}" title="Record contact for ${displayLabel}">Record</a>
						</td>
					</tr>
					<tr class="summary-row ${rowClass} second-row">
						<td class="last-contact-col howwhen-col">${contactedBy ? `${contactedBy} on ${lastDate}` : lastDate}</td>
						<td class="notes-col" colspan="2">${summary}</td>
					</tr>
				</tbody>
			`;
		}).join('');
	});
	</script>
</body>
</html>
