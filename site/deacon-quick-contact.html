
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Deacon Quick Contact - Deacon Care System</title>
	<link rel="stylesheet" href="site.css">
</head>
<body>
	<div class="container">
		<!-- Reusable navigation bar -->
		<div id="site-nav-container"></div>
		<div class="header">
			<h1 style="display:flex;align-items:center;justify-content:center;font-size:1.5em;font-weight:400;gap:0.5em;">
				<span style="font-size:1.1em;">ðŸ“ž</span>
				Deacon Quick Contact
			</h1>
		</div>
		<div class="section">
			<div class="section-title" style="margin-top:16px;">Contacts</div>
			<div class="member-list" id="contacts"></div>
		</div>

	<script type="module">
		import { getBestContactMethod } from './contact-utils.js';
	// Load reusable navigation bar
	document.addEventListener('DOMContentLoaded', async () => {
		const navContainer = document.getElementById('site-nav-container');
		if (navContainer) {
			const navResp = await fetch('site-nav.html');
			if (navResp.ok) {
				navContainer.innerHTML = await navResp.text();
				const script = document.createElement('script');
				script.src = 'site-nav.js';
				document.body.appendChild(script);
			}
		}
	});

	document.addEventListener('DOMContentLoaded', async () => {
		// Get deacon memberId from actsix cookie
		// function getCookie(name) {
		// 	const value = `; ${document.cookie}`;
		// 	const parts = value.split(`; ${name}=`);
		// 	if (parts.length === 2) return parts.pop().split(';').shift();
		// }
		// let deaconMemberId = null;
		// const actsixCookie = getCookie('actsix');
		// if (actsixCookie) {
		// 	const decodedCookie = decodeURIComponent(actsixCookie);
		// 	deaconMemberId = decodedCookie.split('|')[0];
		// }
		// if (!deaconMemberId) {
		// 	if (window.currentMemberId) {
		// 		deaconMemberId = window.currentMemberId;
		// 	} else {
		// 		try {
		// 			const meRes = await fetch('/api/me');
		// 			if (meRes.ok) {
		// 				const meData = await meRes.json();
		// 				deaconMemberId = meData._id;
		// 			}
		// 		} catch (err) {
		// 			const urlParams = new URLSearchParams(window.location.search);
		// 			deaconMemberId = urlParams.get('deaconMemberId');
		// 		}
		// 	}
		// }
		// if (!deaconMemberId) {
		// 	alert('Unable to determine logged-in member (deacon) ID.');
		// 	return;
		// }

		// Fetch assignments for this deacon
		// fetch deaconMemberId from the request parameter or localStorage
		const requestDeaconMemberId = new URLSearchParams(window.location.search).get('deaconMemberId');	
		const deaconMemberId = requestDeaconMemberId || localStorage.getItem('memberId') || 'unknown';
		const assignmentsRes = await fetch(`/api/deacons/${deaconMemberId}/assignments`);
		const assignmentsData = await assignmentsRes.json();
		const assignments = assignmentsData.assignments || [];

		// Helper: build member card
		async function memberCard(householdId) {
			const householdLink = `household.html?id=${householdId}`;
			const contactLink = `record-contact.html?householdId=${householdId}`;

			// Fetch members and household details in parallel
			const [membersRes, householdRes] = await Promise.all([
				fetch(`/api/households/${householdId}/members`),
				fetch(`/api/households/${householdId}`)
			]);

			const membersData = await membersRes.json();
			const members = membersData.members || [];
			const householdData = await householdRes.json();

			// Ensure household object includes members for the utility
			const household = { ...(householdData || {}), members };

			let householdName = members.filter(m => !m.tags?.includes('deceased')).map(m => m.firstName).join(' & ');
			householdName += ' ' + (members[0]?.lastName || '');

			const contactMethodHtml = getBestContactMethod(household);

			// Compact single-line layout: name + contact method on left, record button on right
			return `
				<div class="member-row" style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;">
					<div style="display:flex;align-items:center;gap:12px;min-width:0;">
						<a href="${householdLink}" style="color:inherit;text-decoration:underline;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:40vw;">${householdName}</a>
						<span style="color:#666;font-size:0.95em;white-space:nowrap;">${contactMethodHtml}</span>
					</div>
					<a href="${contactLink}" class="btn" style="margin-left:12px;flex-shrink:0;">Record</a>
				</div>
			`;
		}

		// Render contact cards
		const contactCards = [];
		for (const assign of assignments) {
			contactCards.push(await memberCard(assign.householdId));
		}
		document.getElementById('contacts').innerHTML = contactCards.join('');
	});
	</script>
</body>
</html>
